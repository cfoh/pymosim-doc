
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>List of Packages and Modules &#8212; PyMoSim v0.8 Manual</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="comm package" href="comm.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="#">
  <img src="_static/icon.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="comm.html">
  comm package
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="node.html">
  node package
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="sim.html">
  sim package
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="map.html">
  map package
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/cfoh/pymosim" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   List of Packages and Modules
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#list-of-examples">
   List of Examples
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#module-example1">
     Example 1
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#module-example2">
     Example 2
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#module-example3">
     Example 3
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#module-example4">
     Example 4
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#module-example5">
     Example 5
    </a>
    <ul class="visible nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#references">
       References
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#module-example6">
     Example 6
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#module-example7">
     Example 7
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#module-example8">
     Example 8
    </a>
    <ul class="visible nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       References
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#result-comparison">
       Result Comparison
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#indices-and-tables">
   Indices and tables
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="list-of-packages-and-modules">
<h1>List of Packages and Modules<a class="headerlink" href="#list-of-packages-and-modules" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="comm.html">comm package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="comm.html#submodules">Submodules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="comm.channel.html">comm.channel module</a></li>
<li class="toctree-l3"><a class="reference internal" href="comm.ltemodel.html">comm.ltemodel module</a></li>
<li class="toctree-l3"><a class="reference internal" href="comm.mmwave28.html">comm.mmwave28 module</a></li>
<li class="toctree-l3"><a class="reference internal" href="comm.signalwave.html">comm.signalwave module</a></li>
<li class="toctree-l3"><a class="reference internal" href="comm.transceiver.html">comm.transceiver module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="comm.html#module-comm">Module contents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="node.html">node package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="node.html#submodules">Submodules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="node.draw.html">node.draw module</a></li>
<li class="toctree-l3"><a class="reference internal" href="node.mobility.html">node.mobility module</a></li>
<li class="toctree-l3"><a class="reference internal" href="node.mobility2.html">node.mobility2 module</a></li>
<li class="toctree-l3"><a class="reference internal" href="node.mobility2b.html">node.mobility2b module</a></li>
<li class="toctree-l3"><a class="reference internal" href="node.mobility3.html">node.mobility3 module</a></li>
<li class="toctree-l3"><a class="reference internal" href="node.node.html">node.node module</a></li>
<li class="toctree-l3"><a class="reference internal" href="node.obstacle.html">node.obstacle module</a></li>
<li class="toctree-l3"><a class="reference internal" href="node.routemobi.html">node.routemobi module</a></li>
<li class="toctree-l3"><a class="reference internal" href="node.timer.html">node.timer module</a></li>
<li class="toctree-l3"><a class="reference internal" href="node.type.html">node.type module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="node.html#module-node">Module contents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="sim.html">sim package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="sim.html#submodules">Submodules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="sim.direction.html">sim.direction module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sim.drawable.html">sim.drawable module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sim.event.html">sim.event module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sim.frame.html">sim.frame module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sim.loc.html">sim.loc module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sim.scenario.html">sim.scenario module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sim.simsystem.html">sim.simsystem module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sim.simulation.html">sim.simulation module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sim.version.html">sim.version module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="sim.html#module-sim">Module contents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="map.html">map package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="map.html#submodules">Submodules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="map.mapinfo.html">map.mapinfo module</a></li>
<li class="toctree-l3"><a class="reference internal" href="map.pin.html">map.pin module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="map.html#module-map">Module contents</a></li>
</ul>
</li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The release version of this documentation can be found
here: <a class="reference internal" href="sim.version.html#sim.version.Version" title="sim.version.Version"><code class="xref py py-class docutils literal notranslate"><span class="pre">sim.version.Version</span></code></a>.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="list-of-examples">
<h1>List of Examples<a class="headerlink" href="#list-of-examples" title="Permalink to this headline">¶</a></h1>
<div class="section" id="module-example1">
<span id="example-1"></span><h2>Example 1<a class="headerlink" href="#module-example1" title="Permalink to this headline">¶</a></h2>
<p>This is a simple example to show how a simualtion can be created within 50 lines.</p>
<img alt="_images/example1.gif" src="_images/example1.gif" />
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;This is a simple example to show how a simualtion can be created within 50 lines.&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">sim.simulation</span> <span class="kn">import</span> <span class="n">World</span>
<span class="kn">from</span> <span class="nn">sim.loc</span> <span class="kn">import</span> <span class="n">ScreenXY</span> <span class="k">as</span> <span class="n">XY</span>
<span class="kn">from</span> <span class="nn">sim.scenario</span> <span class="kn">import</span> <span class="n">BaseScenario</span>
<span class="kn">from</span> <span class="nn">node.node</span> <span class="kn">import</span> <span class="n">BaseNode</span>
<span class="kn">from</span> <span class="nn">node.type</span> <span class="kn">import</span> <span class="n">BaseStation</span><span class="p">,</span> <span class="n">Vehicle</span>
<span class="kn">from</span> <span class="nn">node.mobility</span> <span class="kn">import</span> <span class="n">Stationary</span><span class="p">,</span> <span class="n">StaticPath</span>
<span class="kn">from</span> <span class="nn">comm.transceiver</span> <span class="kn">import</span> <span class="n">Transceiver</span>
<span class="kn">from</span> <span class="nn">comm.channel</span> <span class="kn">import</span> <span class="n">DiscModel</span>

<span class="k">class</span> <span class="nc">MyBS</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;MyBS: This is a base station design.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="n">BaseStation</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_transceiver</span><span class="p">(</span><span class="n">Transceiver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">freq</span><span class="p">,</span> <span class="n">channel</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">Stationary</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">MyVehicle</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;MyVehicle: This is a vehicle design.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">start_loc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="n">Vehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_transceiver</span><span class="p">(</span><span class="n">Transceiver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">freq</span><span class="p">,</span> <span class="n">channel</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">StaticPath</span><span class="p">(</span><span class="n">start_loc</span><span class="p">,</span><span class="n">path</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">MyScenario</span><span class="p">(</span><span class="n">BaseScenario</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This is MyScenario. It reimplements on_create() and on_event().&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">on_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> <span class="c1"># this will be called at the start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;A simulation in less than 50 lines&quot;</span><span class="p">)</span>
        <span class="n">omni</span> <span class="o">=</span> <span class="n">DiscModel</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_bs</span> <span class="o">=</span> <span class="n">MyBS</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="s2">&quot;BS&quot;</span><span class="p">,</span> <span class="n">XY</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span><span class="mi">100</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="mf">2.4</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">omni</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_vehicle</span> <span class="o">=</span> <span class="n">MyVehicle</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Vehicle&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mf">2.4</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">omni</span><span class="p">,</span>
                                    <span class="n">start_loc</span><span class="o">=</span><span class="n">XY</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">130</span><span class="p">),</span> <span class="n">path</span><span class="o">=</span><span class="p">[(</span><span class="mi">60</span><span class="p">,</span><span class="n">XY</span><span class="p">(</span><span class="mi">350</span><span class="p">,</span><span class="mi">130</span><span class="p">))])</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">on_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">):</span> <span class="c1"># this will be called repeatedly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_bs</span><span class="o">.</span><span class="n">clear_drawing</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_vehicle</span><span class="o">.</span><span class="n">clear_drawing</span><span class="p">()</span>
        <span class="n">beacon_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_bs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;transceiver&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="n">signal</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_bs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;transceiver&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">beacon_message</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_vehicle</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">my_bs</span><span class="o">.</span><span class="n">draw_circle</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">my_vehicle</span><span class="o">.</span><span class="n">draw_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_bs</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">World</span><span class="p">()</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">sim_stop</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">sim_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">sim_speed</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">display_option</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
               <span class="n">scenario</span><span class="o">=</span><span class="n">MyScenario</span><span class="p">(</span><span class="n">sim</span><span class="p">))</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="module-example2">
<span id="example-2"></span><h2>Example 2<a class="headerlink" href="#module-example2" title="Permalink to this headline">¶</a></h2>
<p>This is an example which demonstrates a cluster of sectorized BSs serving vehicles in a 
highway scenario. The mobility of vehicles is predefined and static in this example.
The simulation will run for 10 seconds.</p>
<p>In this example, we use vehicle centric where vehicle will send a hello message
to collect signal quality from all sectors of all BSs, and then associate with the sector 
with the highest quality (i.e. strongest SNR). The example shows how to use Transceiver
class to send and detect signals, and measure the signal quality of a received signal.</p>
<img alt="_images/example2.gif" src="_images/example2.gif" />
<details class="summary-show-source-code">
<summary>Show source code</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This is an example which demonstrates a cluster of sectorized BSs serving vehicles in a </span>
<span class="sd">highway scenario. The mobility of vehicles is predefined and static in this example.</span>
<span class="sd">The simulation will run for 10 seconds.</span>

<span class="sd">In this example, we use vehicle centric where vehicle will send a hello message</span>
<span class="sd">to collect signal quality from all sectors of all BSs, and then associate with the sector </span>
<span class="sd">with the highest quality (i.e. strongest SNR). The example shows how to use Transceiver</span>
<span class="sd">class to send and detect signals, and measure the signal quality of a received signal.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">wx</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span><span class="p">,</span> <span class="n">ArgumentParser</span>
<span class="kn">from</span> <span class="nn">sim.simulation</span> <span class="kn">import</span> <span class="n">World</span>
<span class="kn">from</span> <span class="nn">sim.loc</span> <span class="kn">import</span> <span class="n">ScreenXY</span> <span class="k">as</span> <span class="n">XY</span>
<span class="kn">from</span> <span class="nn">sim.scenario</span> <span class="kn">import</span> <span class="n">BaseScenario</span>
<span class="kn">from</span> <span class="nn">sim.event</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">node.node</span> <span class="kn">import</span> <span class="n">BaseNode</span>
<span class="kn">from</span> <span class="nn">node.mobility</span> <span class="kn">import</span> <span class="n">Stationary</span><span class="p">,</span> <span class="n">StaticPath</span>
<span class="kn">from</span> <span class="nn">comm.transceiver</span> <span class="kn">import</span> <span class="n">Transceiver</span><span class="p">,</span> <span class="n">TransceiverDir</span>
<span class="kn">from</span> <span class="nn">comm.channel</span> <span class="kn">import</span> <span class="n">DiscModel</span>
<span class="kn">import</span> <span class="nn">node.type</span> <span class="k">as</span> <span class="nn">NodeType</span>

<span class="c1">####################################################################</span>
<span class="c1">## Nodes</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">MySector</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MySector: This is a sector of a base station in the VANET sim world</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">sector_width</span><span class="p">,</span> <span class="n">sector_dir</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">BaseStation</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">TransceiverDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">freq</span><span class="p">,</span><span class="n">channel</span><span class="p">,</span><span class="n">sector_width</span><span class="p">,</span><span class="n">sector_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serving_node</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">## setup the sector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_transceiver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">Stationary</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>

    <span class="c1">## show the coverage of this sector</span>
    <span class="k">def</span> <span class="nf">show_coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_drawing</span><span class="p">()</span> <span class="c1"># this is persistent drawing, so need to clear the all first</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serving_node</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;omni&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw_circle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;directional&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw_sector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;azimuth&quot;</span><span class="p">),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;beam width&quot;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">MyVehicle</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MyVehicle: This is a transmitting node in the VANET sim world</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">Vehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="c1">## initialize some properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">Transceiver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">freq</span><span class="p">,</span><span class="n">channel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_transceiver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">## initialize some variables to collect statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectivity</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="c1"># list of connections: [sector, start_time, end_time]</span>

    <span class="c1">## associate with a sector</span>
    <span class="k">def</span> <span class="nf">associate_sector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sector</span><span class="p">,</span><span class="n">time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span> <span class="o">=</span> <span class="n">sector</span>
        <span class="n">sector</span><span class="o">.</span><span class="n">serving_node</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectivity</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sector</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1">## remove sector association due to lost of connection</span>
    <span class="k">def</span> <span class="nf">lost_sector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span><span class="o">.</span><span class="n">serving_node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectivity</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connectivity</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span>

    <span class="c1">## draw a line to the associated sector, if any</span>
    <span class="k">def</span> <span class="nf">show_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_drawing</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">BLACK</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span>


<span class="c1">####################################################################</span>
<span class="c1">## Scenario</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">MyScenario</span><span class="p">(</span><span class="n">BaseScenario</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MyScenario: This is my scenario</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">##---------------------------------------------------------------</span>
    <span class="c1">## This method will be called before the start of the simulation,</span>
    <span class="c1">## build the simulation world here</span>
    <span class="k">def</span> <span class="nf">on_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>

        <span class="c1">## give a name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;A simple example&quot;</span><span class="p">)</span>

        <span class="c1">## create a common channel</span>
        <span class="n">carrier_freq</span> <span class="o">=</span> <span class="mf">2.4</span>
        <span class="n">coverage_range</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">beam_width</span> <span class="o">=</span> <span class="mi">60</span>
        <span class="n">sector_dir</span> <span class="o">=</span> <span class="p">[</span><span class="mi">180</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="o">+</span><span class="mi">60</span><span class="p">]</span>
        <span class="n">ch_omni</span> <span class="o">=</span> <span class="n">DiscModel</span><span class="p">(</span><span class="n">coverage_range</span><span class="p">)</span>
        
        <span class="c1">## create some nodes on the map</span>
        <span class="n">bs_locs</span> <span class="o">=</span> <span class="p">[</span><span class="n">XY</span><span class="p">(</span><span class="mi">110</span><span class="p">,</span><span class="mi">140</span><span class="p">),</span><span class="n">XY</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span><span class="mi">140</span><span class="p">),</span><span class="n">XY</span><span class="p">(</span><span class="mi">280</span><span class="p">,</span><span class="mi">135</span><span class="p">)]</span> <span class="c1"># locations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sectors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">bs_locs</span><span class="p">)):</span> <span class="c1"># BSs</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">sector_dir</span><span class="p">)):</span> <span class="c1"># sectors for each BS</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="s2">&quot;BS-</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">sector</span> <span class="o">=</span> <span class="n">MySector</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">bs_locs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">carrier_freq</span><span class="p">,</span> <span class="n">ch_omni</span><span class="p">,</span> 
                                  <span class="n">beam_width</span><span class="p">,</span> <span class="n">sector_dir</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sector</span><span class="p">)</span>

        <span class="c1">## create some vehicles on the highway</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">XY</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">)),</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">XY</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span><span class="mi">200</span><span class="p">))</span> <span class="p">]</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">MyVehicle</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Vehicle1&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">carrier_freq</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">ch_omni</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">StaticPath</span><span class="p">(</span><span class="n">start_loc</span><span class="o">=</span><span class="n">XY</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">200</span><span class="p">),</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">XY</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span><span class="mi">180</span><span class="p">)),</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">XY</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">180</span><span class="p">))</span> <span class="p">]</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">MyVehicle</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Vehicle2&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">carrier_freq</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">ch_omni</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">StaticPath</span><span class="p">(</span><span class="n">start_loc</span><span class="o">=</span><span class="n">XY</span><span class="p">(</span><span class="mi">390</span><span class="p">,</span><span class="mi">180</span><span class="p">),</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1">##-------------------------------------------------------------</span>
    <span class="c1">## This method will be called repeatedly until the simulation</span>
    <span class="c1">## is ended or stopped, perform any user simulation action here</span>
    <span class="k">def</span> <span class="nf">on_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">):</span>

        <span class="n">all_vehicles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span>
        <span class="n">all_sectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sectors</span>

        <span class="c1">## check vehicle connectivity with its associated sector</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span>
            <span class="n">my_sector</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">associated_sector</span>
            <span class="k">if</span> <span class="n">my_sector</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if none</span>

            <span class="n">beacon</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">unicast</span><span class="p">(</span><span class="n">beacon</span><span class="p">,</span><span class="n">my_sector</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># lost connection</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">lost_sector</span><span class="p">(</span><span class="n">sim_time</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;at t=</span><span class="si">%1.2f</span><span class="s2">, </span><span class="si">%s</span><span class="s2"> lost connection with </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">sim_time</span><span class="p">,</span><span class="n">vehicle</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">my_sector</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="c1">## make associatiation with sector if needed</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span>

            <span class="c1">## step 1: check sector association, skip if already associated</span>
            <span class="k">if</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">associated_sector</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>

            <span class="c1">## step 2: find strongest SNR to associate</span>
            <span class="n">sector_max</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">detection_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">beacon</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
            <span class="n">reply_list</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">beacon</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">sector</span><span class="p">,</span><span class="n">signal</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reply_list</span><span class="p">:</span>
                <span class="c1">## 2.1 check that the reachable node is a sector currently not serving other</span>
                <span class="k">if</span> <span class="n">sector</span><span class="o">.</span><span class="n">type</span><span class="o">!=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">BaseStation</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if not a base station type</span>
                <span class="k">if</span> <span class="n">sector</span><span class="o">.</span><span class="n">serving_node</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if sector is already serving other</span>

                <span class="c1">## 2.2 sector beam replies beacon for vehicle to obtain the signal quality</span>
                <span class="n">beacon_reply</span> <span class="o">=</span> <span class="n">sector</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
                <span class="n">recv_signal</span> <span class="o">=</span> <span class="n">sector</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">unicast</span><span class="p">(</span><span class="n">beacon_reply</span><span class="p">,</span><span class="n">vehicle</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">recv_signal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if failed, likely not in coverage</span>

                <span class="c1">## 2.3 append to the detection list</span>
                <span class="n">detection_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sector</span><span class="p">,</span><span class="n">recv_signal</span><span class="o">.</span><span class="n">quality</span><span class="p">))</span>

            <span class="c1">## step 3: associate with the sector with the strongest SNR, if exists</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">detection_list</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">sector_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">detection_list</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sector_max</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">associate_sector</span><span class="p">(</span><span class="n">sector_max</span><span class="p">,</span><span class="n">sim_time</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;at t=</span><span class="si">%1.2f</span><span class="s2">, </span><span class="si">%s</span><span class="s2"> associated with </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">sim_time</span><span class="p">,</span><span class="n">vehicle</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">sector_max</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="c1">## draw connectivity &amp; beam coverage on the map</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span>
            <span class="n">vehicle</span><span class="o">.</span><span class="n">show_connection</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sector</span> <span class="ow">in</span> <span class="n">all_sectors</span><span class="p">:</span>
            <span class="n">sector</span><span class="o">.</span><span class="n">show_coverage</span><span class="p">()</span>

        <span class="c1">## print statistics at the end of the simulation</span>
        <span class="k">if</span> <span class="n">event_obj</span><span class="o">==</span><span class="n">Event</span><span class="o">.</span><span class="n">SIM_END</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Statistics (connected BS=duration):&quot;</span><span class="p">)</span>
            <span class="n">conn_info_all</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">average_all</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span> <span class="c1"># get statistics into `conn_info_all[]`</span>
                <span class="n">conn_info_each</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">sum_duration</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">connection_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">connectivity</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">conn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">conn_info_each</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">conn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">conn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">conn</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="n">sum_duration</span> <span class="o">+=</span> <span class="n">conn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">conn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">connection_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">conn_info_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conn_info_each</span><span class="p">)</span>
                <span class="n">average_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sum_duration</span><span class="o">/</span><span class="n">connection_count</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">print_fixed</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">text</span><span class="si">:</span><span class="s2">15</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span> <span class="c1"># line 1, heading</span>
                <span class="n">print_fixed</span><span class="p">(</span><span class="n">vehicle</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">max_record</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span> <span class="c1"># line 2, separator</span>
                <span class="n">print_fixed</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">vehicle</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">conn_info_all</span><span class="p">:</span> <span class="c1"># line 3..., connection info</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">)</span><span class="o">&gt;</span><span class="n">max_record</span><span class="p">:</span>
                    <span class="n">max_record</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">max_record</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">vnode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">conn_info_all</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">idx</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">conn_info_all</span><span class="p">[</span><span class="n">vnode</span><span class="p">]):</span>
                        <span class="n">print_fixed</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%1.2f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">conn_info_all</span><span class="p">[</span><span class="n">vnode</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                <span class="n">conn_info_all</span><span class="p">[</span><span class="n">vnode</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">print_fixed</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span>  <span class="c1"># 2nd last line, separator</span>
                <span class="n">print_fixed</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">vehicle</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">average</span> <span class="ow">in</span> <span class="n">average_all</span><span class="p">:</span>   <span class="c1"># last line, average values</span>
                <span class="n">print_fixed</span><span class="p">(</span><span class="s2">&quot;Mean=</span><span class="si">%1.2f</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">average</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>


<span class="c1">####################################################################</span>
<span class="c1">## main</span>
<span class="c1">####################################################################</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1">## command line parameters</span>
    <span class="n">parser</span><span class="p">:</span> <span class="n">ArgumentParser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--nodisplay&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run in no GUI mode&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--step&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Mobility step time (in sec)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--speed&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Animation playback speed (x times)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--duration&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Simulation duration (in sec), -1 for non-stop&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Namespace</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1">## welcome info</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A Simple VANET Environment. Press [^C] to quit&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nodisplay</span><span class="p">:</span>   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- simulation will run without animation&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- animation will playback at x</span><span class="si">%1.2f</span><span class="s2"> speed&quot;</span><span class="o">%</span><span class="n">args</span><span class="o">.</span><span class="n">speed</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- vehicles move a step every </span><span class="si">%1.2f</span><span class="s2"> s in simulation&quot;</span><span class="o">%</span><span class="n">args</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">duration</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- simulation will stop at </span><span class="si">%1.2f</span><span class="s2"> s&quot;</span><span class="o">%</span><span class="n">args</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- simulation will run non-stop&quot;</span><span class="p">)</span>

    <span class="c1">## create, setup and run the simulation</span>
    <span class="c1">## note that to run a simulation, we need to create a &#39;scenario&#39;</span>
    <span class="n">run_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">run_flag</span><span class="p">:</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">World</span><span class="p">()</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">sim_stop</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> 
                <span class="n">sim_step</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> 
                <span class="n">sim_speed</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">speed</span><span class="p">,</span> 
                <span class="n">display_option</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">nodisplay</span><span class="p">,</span> 
                <span class="n">scenario</span> <span class="o">=</span> <span class="n">MyScenario</span><span class="p">(</span><span class="n">sim</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running PyMoSim version v</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">sim</span><span class="o">.</span><span class="n">version</span><span class="p">())</span>
        <span class="n">run_flag</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    
</pre></div>
</div>
</details></div>
<div class="section" id="module-example3">
<span id="example-3"></span><h2>Example 3<a class="headerlink" href="#module-example3" title="Permalink to this headline">¶</a></h2>
<p>This is an example which demonstrates a cluster of mmWave BSs serving vehicles 
in a highway (M26) scenario. The background is a static image of M26 highway, 
and the mobility of the vehicles is carefully designed so that they appear
moving on the highway. 
The simulation run continuously. Our design and assumptions are:</p>
<ul class="simple">
<li><p>Vehicle Centric: Vehicle will send a hello beacon message to collect signal quality 
from all BS sectors, and then choose a sector to assiciate.</p></li>
<li><p>Strongest SNR: When choosing a BS to associate, the vehicle always pick the one
with the highest signal quality (i.e. strongest SNR).</p></li>
<li><p>Simultaneous beams: A BS may have multiple radio heads (RHs), each RH radiates 
a beam on a sector. The BS can use all beams at the same time, each beam can serve 
a vehicle. If, say, the BS has 3 beams, and the condition is right, the BS can turn 
all beams active to serve 3 different vehicles at the same time.</p></li>
<li><p>Interference: If a vehicle is simultaneously covered by two active beams,
interference occurs, and the transmission during that simulation time step is 
considered unsuccessful. We assume that the vehicle remains associated with the
BS, but the transmission rate for that time step is zero.</p></li>
<li><p>Beam and channel model: There are two options in this example.</p>
<ul>
<li><p>Option 1: Vehicles use omni-directional ideal Disc model, BSs use 6 ideal sectors. 
All 6 sectors combined give a perfect circle coverage. This is the default option.</p></li>
<li><p>Option 2: Vehicles use omni-directional Disc model, BSs use 28GHz mmWave beamforming 
to create 6 sectors.</p></li>
</ul>
</li>
</ul>
<img alt="_images/example3.gif" src="_images/example3.gif" />
<details class="summary-show-source-code">
<summary>Show source code</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This is an example which demonstrates a cluster of mmWave BSs serving vehicles </span>
<span class="sd">in a highway (M26) scenario. The background is a static image of M26 highway, </span>
<span class="sd">and the mobility of the vehicles is carefully designed so that they appear</span>
<span class="sd">moving on the highway. </span>
<span class="sd">The simulation run continuously. Our design and assumptions are:</span>

<span class="sd">- Vehicle Centric: Vehicle will send a hello beacon message to collect signal quality </span>
<span class="sd">  from all BS sectors, and then choose a sector to assiciate.</span>
<span class="sd">- Strongest SNR: When choosing a BS to associate, the vehicle always pick the one</span>
<span class="sd">  with the highest signal quality (i.e. strongest SNR).</span>
<span class="sd">- Simultaneous beams: A BS may have multiple radio heads (RHs), each RH radiates </span>
<span class="sd">  a beam on a sector. The BS can use all beams at the same time, each beam can serve </span>
<span class="sd">  a vehicle. If, say, the BS has 3 beams, and the condition is right, the BS can turn </span>
<span class="sd">  all beams active to serve 3 different vehicles at the same time.</span>
<span class="sd">- Interference: If a vehicle is simultaneously covered by two active beams,</span>
<span class="sd">  interference occurs, and the transmission during that simulation time step is </span>
<span class="sd">  considered unsuccessful. We assume that the vehicle remains associated with the</span>
<span class="sd">  BS, but the transmission rate for that time step is zero.</span>
<span class="sd">- Beam and channel model: There are two options in this example. </span>

<span class="sd">  - Option 1: Vehicles use omni-directional ideal Disc model, BSs use 6 ideal sectors. </span>
<span class="sd">    All 6 sectors combined give a perfect circle coverage. This is the default option.</span>
<span class="sd">  - Option 2: Vehicles use omni-directional Disc model, BSs use 28GHz mmWave beamforming </span>
<span class="sd">    to create 6 sectors.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">wx</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span><span class="p">,</span> <span class="n">ArgumentParser</span>
<span class="kn">from</span> <span class="nn">sim.simulation</span> <span class="kn">import</span> <span class="n">World</span>
<span class="kn">from</span> <span class="nn">sim.loc</span> <span class="kn">import</span> <span class="n">ScreenXY</span> <span class="k">as</span> <span class="n">XY</span>
<span class="kn">from</span> <span class="nn">sim.scenario</span> <span class="kn">import</span> <span class="n">BaseScenario</span>
<span class="kn">from</span> <span class="nn">sim.event</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">node.node</span> <span class="kn">import</span> <span class="n">BaseNode</span>
<span class="kn">from</span> <span class="nn">node.mobility</span> <span class="kn">import</span> <span class="n">Stationary</span><span class="p">,</span> <span class="n">StaticPath</span>
<span class="kn">from</span> <span class="nn">comm.transceiver</span> <span class="kn">import</span> <span class="n">Transceiver</span><span class="p">,</span> <span class="n">TransceiverDir</span>
<span class="kn">from</span> <span class="nn">comm.channel</span> <span class="kn">import</span> <span class="n">DiscModel</span>
<span class="kn">import</span> <span class="nn">node.type</span> <span class="k">as</span> <span class="nn">NodeType</span>

<span class="c1">## for mmWave transmission, we need the following:</span>
<span class="kn">from</span> <span class="nn">comm.mmwave28</span> <span class="kn">import</span> <span class="n">Channel28GHz</span><span class="p">,</span> <span class="n">Transceiver28GHz</span><span class="p">,</span> <span class="n">Transceiver28GHzOmni</span>

<span class="c1">## pick option 1 or option 2</span>
<span class="k">class</span> <span class="nc">GlobalVariable</span><span class="p">:</span> <span class="k">pass</span>
<span class="n">global_var</span> <span class="o">=</span> <span class="n">GlobalVariable</span><span class="p">()</span>
<span class="n">global_var</span><span class="o">.</span><span class="n">option</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># option 1: ideal disc channel model</span>
<span class="c1">#global_var.option = 2  # option 2: mmWave beamforming model</span>

<span class="c1">####################################################################</span>
<span class="c1">## Helper</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">DebugPrint</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="c1"># comment this line out to disable debug printing</span>
        <span class="k">pass</span>

<span class="c1">####################################################################</span>
<span class="c1">## Nodes</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">MySector</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MySector: This is a base station in the VANET sim world implementing</span>
<span class="sd">    ideal sector radiation (option 1) or mmWave beamforming (option 2)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">sector_width</span><span class="p">,</span> <span class="n">sector_dir</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">BaseStation</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="c1">## create transceiver</span>
        <span class="k">if</span> <span class="n">global_var</span><span class="o">.</span><span class="n">option</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">TransceiverDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">freq</span><span class="p">,</span><span class="n">channel</span><span class="p">,</span><span class="n">sector_width</span><span class="p">,</span><span class="n">sector_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">global_var</span><span class="o">.</span><span class="n">option</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="c1">## convert sector_width to beam_3dB</span>
            <span class="c1">#  for 6 sectors, sector_width=60.  Based on 3GPP, beam_3dB = 35 </span>
            <span class="c1">#  for 3 sectors, sector_width=120. Based on 3GPP, beam_3dB = 70 </span>
            <span class="c1">#  so, beam_3dB = sector_width * 35/60 degree (to convert to rad)</span>
            <span class="n">beam_3dB_rad</span> <span class="o">=</span> <span class="n">sector_width</span> <span class="o">*</span> <span class="mi">35</span><span class="o">/</span><span class="mi">60</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>

            <span class="c1">## setup the transceiver to create coverage range around 80</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">Transceiver28GHz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
                                        <span class="n">tx_power</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="c1"># dBm</span>
                                        <span class="n">gain_tx</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>   <span class="c1"># dB</span>
                                        <span class="n">beam_3dB</span><span class="o">=</span><span class="n">beam_3dB_rad</span><span class="p">,</span> 
                                        <span class="n">pointing_dir</span><span class="o">=</span><span class="n">sector_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">serving_node</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">## setup the sector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_transceiver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">Stationary</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>

    <span class="c1">## show the coverage of this sector</span>
    <span class="k">def</span> <span class="nf">show_coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_drawing</span><span class="p">()</span> <span class="c1"># this is persistent drawing, so need to clear the all first</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serving_node</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;omni&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw_circle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;directional&quot;</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;mmWaveBeam&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw_sector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;azimuth&quot;</span><span class="p">),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;beam width&quot;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">MyVehicle</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MyVehicle: This is a transmitting node in the VANET sim world</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">Vehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="c1">## create transceiver</span>
        <span class="k">if</span> <span class="n">global_var</span><span class="o">.</span><span class="n">option</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">Transceiver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">freq</span><span class="p">,</span><span class="n">channel</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">global_var</span><span class="o">.</span><span class="n">option</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">Transceiver28GHzOmni</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
                                        <span class="n">tx_power</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="c1"># dBm</span>
                                        <span class="n">gain_tx</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>   <span class="c1"># dB</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_transceiver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_interference</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">curr_conn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectivity</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="c1"># list of connections: [sector, start_time, end_time]</span>

    <span class="k">def</span> <span class="nf">associate_sector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sector</span><span class="p">,</span><span class="n">time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span> <span class="o">=</span> <span class="n">sector</span>
        <span class="n">sector</span><span class="o">.</span><span class="n">serving_node</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectivity</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sector</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_conn</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">lost_sector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span><span class="o">.</span><span class="n">serving_node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectivity</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_conn</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span>

    <span class="c1">## draw a line to the associated sector, if any</span>
    <span class="k">def</span> <span class="nf">show_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_drawing</span><span class="p">()</span> <span class="c1"># this is persistent drawing, so need to clear the all first</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_interference</span><span class="p">:</span> 
                <span class="c1"># vehicle with a sector &amp; has interference</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">BLACK</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span><span class="p">,</span><span class="n">pen</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Pen</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">BLACK</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">PENSTYLE_SHORT_DASH</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>  
                <span class="c1"># vehicle with a sector &amp; has no interference</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span><span class="p">,</span><span class="n">pen</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Pen</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">BLUE</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">PENSTYLE_SOLID</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">BLUE</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># vehicle without a sector association</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span>

<span class="c1">####################################################################</span>
<span class="c1">## Scenario</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">MyScenario</span><span class="p">(</span><span class="n">BaseScenario</span><span class="p">,</span><span class="n">DebugPrint</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MyScenario: This is my scenario</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">## ------------------------------------------------------------</span>
    <span class="c1">## This method will be called before the start of the simulation,</span>
    <span class="c1">## build the simulation world here</span>
    <span class="k">def</span> <span class="nf">on_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>

        <span class="c1">## simulation variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simworld</span> <span class="o">=</span> <span class="n">simworld</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simworld</span><span class="o">.</span><span class="n">is_animation_shown</span><span class="p">():</span>
            <span class="n">bitmap</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Bitmap</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">bitmap</span><span class="o">.</span><span class="n">LoadFile</span><span class="p">(</span><span class="s2">&quot;M26.png&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_background</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error loading bitmap file, no background is applied.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;A busy highway (M26)&quot;</span><span class="p">)</span>

        <span class="c1">## configure tranceiver property for each BS sector</span>
        <span class="n">beam_radius</span> <span class="o">=</span> <span class="mi">80</span>
        <span class="n">beam_num</span> <span class="o">=</span> <span class="mi">6</span>      <span class="c1"># must be an integer</span>
        <span class="n">beam_width</span> <span class="o">=</span> <span class="mi">360</span><span class="o">/</span><span class="n">beam_num</span>
        <span class="n">beam_pointing</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 0 means north</span>
        <span class="n">sector</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">beam_num</span><span class="p">):</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">beam_pointing</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">beam_width</span>
            <span class="k">while</span> <span class="n">angle</span><span class="o">&gt;=</span><span class="mi">360</span><span class="p">:</span> <span class="n">angle</span><span class="o">-=</span><span class="mi">360</span>
            <span class="n">sector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;angle&quot;</span><span class="p">:</span><span class="n">angle</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span><span class="n">beam_width</span><span class="p">}</span>

        <span class="c1">## create channel for signal propagation model</span>
        <span class="n">carrier_freq</span> <span class="o">=</span> <span class="mi">28</span> <span class="c1"># GHz</span>
        <span class="n">ch_disc</span> <span class="o">=</span> <span class="n">DiscModel</span><span class="p">(</span><span class="n">beam_radius</span><span class="p">)</span>
        <span class="n">ch_28GHz</span> <span class="o">=</span> <span class="n">Channel28GHz</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">global_var</span><span class="o">.</span><span class="n">option</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>   <span class="n">channel_model</span> <span class="o">=</span> <span class="n">ch_disc</span>
        <span class="k">elif</span> <span class="n">global_var</span><span class="o">.</span><span class="n">option</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="n">channel_model</span> <span class="o">=</span> <span class="n">ch_28GHz</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Wrong option</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1">## create some nodes on the north and south sides of the highway</span>
        <span class="n">bs_locs</span> <span class="o">=</span> <span class="p">[</span><span class="n">XY</span><span class="p">(</span><span class="mi">110</span><span class="p">,</span><span class="mi">260</span><span class="p">),</span><span class="n">XY</span><span class="p">(</span><span class="mi">210</span><span class="p">,</span><span class="mi">260</span><span class="p">),</span><span class="n">XY</span><span class="p">(</span><span class="mi">340</span><span class="p">,</span><span class="mi">260</span><span class="p">)]</span> <span class="c1"># south locations</span>
        <span class="n">bs_locs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">XY</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">180</span><span class="p">),</span><span class="n">XY</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span><span class="mi">180</span><span class="p">),</span><span class="n">XY</span><span class="p">(</span><span class="mi">360</span><span class="p">,</span><span class="mi">180</span><span class="p">)]</span> <span class="c1"># north locations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bs_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">bs_locs</span><span class="p">)):</span> <span class="c1"># each BS location</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">sector</span><span class="p">)):</span> <span class="c1"># create sectors for each BS</span>
                <span class="n">this_id</span> <span class="o">=</span> <span class="s2">&quot;BS</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                <span class="n">this_node</span> <span class="o">=</span> <span class="n">MySector</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="n">this_id</span><span class="p">,</span> <span class="n">bs_locs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                                        <span class="n">carrier_freq</span><span class="p">,</span> <span class="n">channel_model</span><span class="p">,</span> 
                                        <span class="n">sector_width</span><span class="o">=</span><span class="n">sector</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">],</span> 
                                        <span class="n">sector_dir</span><span class="o">=</span><span class="n">sector</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;angle&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bs_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_node</span><span class="p">)</span>

        <span class="c1">## setup vehicle info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicle_info</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># list of [start location, end location]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">205</span><span class="p">;</span> <span class="n">space</span><span class="o">=</span><span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicle_info</span><span class="p">[</span><span class="s2">&quot;car1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">XY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="n">XY</span><span class="p">(</span><span class="mi">480</span><span class="p">,</span><span class="n">y</span><span class="p">)];</span> <span class="n">y</span><span class="o">+=</span><span class="n">space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicle_info</span><span class="p">[</span><span class="s2">&quot;car2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">XY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="n">XY</span><span class="p">(</span><span class="mi">480</span><span class="p">,</span><span class="n">y</span><span class="p">)];</span> <span class="n">y</span><span class="o">+=</span><span class="n">space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicle_info</span><span class="p">[</span><span class="s2">&quot;car3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">XY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="n">XY</span><span class="p">(</span><span class="mi">480</span><span class="p">,</span><span class="n">y</span><span class="p">)];</span> <span class="n">y</span><span class="o">+=</span><span class="n">space</span><span class="o">+</span><span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicle_info</span><span class="p">[</span><span class="s2">&quot;car4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">XY</span><span class="p">(</span><span class="mi">480</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="n">XY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="p">)];</span> <span class="n">y</span><span class="o">+=</span><span class="n">space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicle_info</span><span class="p">[</span><span class="s2">&quot;car5&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">XY</span><span class="p">(</span><span class="mi">480</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="n">XY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="p">)];</span> <span class="n">y</span><span class="o">+=</span><span class="n">space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicle_info</span><span class="p">[</span><span class="s2">&quot;car6&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">XY</span><span class="p">(</span><span class="mi">480</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="n">XY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="p">)];</span> <span class="n">y</span><span class="o">+=</span><span class="n">space</span>

        <span class="c1">## create the vehicles on the highway based on above info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vehicle_info</span><span class="p">:</span>
            <span class="n">start_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vehicle_info</span><span class="p">[</span><span class="n">info</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">end_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vehicle_info</span><span class="p">[</span><span class="n">info</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">path</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">60</span><span class="p">),</span> <span class="n">end_loc</span><span class="p">)</span> <span class="p">]</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">MyVehicle</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">carrier_freq</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">channel_model</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">StaticPath</span><span class="p">(</span><span class="n">start_loc</span><span class="o">=</span><span class="n">start_loc</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="c1"># put the following into the class property, needed in `do_restart_node()`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">carrier_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span> <span class="o">=</span> <span class="n">channel_model</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1">## --------------------------------------------------------</span>
    <span class="c1">## This method will be called repeatedly until the simulation</span>
    <span class="c1">## is ended or stopped, perform any simulation action here</span>
    <span class="k">def</span> <span class="nf">on_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">event_obj</span><span class="o">==</span><span class="n">Event</span><span class="o">.</span><span class="n">MOBILITY_END</span><span class="p">:</span> <span class="c1"># a mobile node has finished its mobility?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_restart_node</span><span class="p">(</span><span class="n">sim_time</span><span class="p">,</span><span class="n">event_obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event_obj</span><span class="o">==</span><span class="n">Event</span><span class="o">.</span><span class="n">SIM_MOBILITY</span><span class="p">:</span> <span class="c1"># mobility progresses a time step?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_mobility</span><span class="p">(</span><span class="n">sim_time</span><span class="p">,</span><span class="n">event_obj</span><span class="p">)</span>

    <span class="c1">## end of mobility, then create a new vehicle to replace this one</span>
    <span class="k">def</span> <span class="nf">do_restart_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">):</span>
        <span class="n">this_node</span> <span class="o">=</span> <span class="n">event_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">)</span> <span class="c1"># get the node reaching end of mobility</span>

        <span class="n">speed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span>                  <span class="c1"># new speed</span>
        <span class="n">start_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vehicle_info</span><span class="p">[</span><span class="n">this_node</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># new start location</span>
        <span class="n">end_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vehicle_info</span><span class="p">[</span><span class="n">this_node</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># new end location</span>
        <span class="n">new_path</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="n">end_loc</span><span class="p">)</span> <span class="p">]</span>                <span class="c1"># build a new path</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="n">MyVehicle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">this_node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                             <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="p">)</span>
        <span class="n">new_node</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">StaticPath</span><span class="p">(</span><span class="n">start_loc</span><span class="o">=</span><span class="n">start_loc</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="n">new_path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_node</span><span class="p">)</span> <span class="c1"># add new node to our list</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">this_node</span><span class="p">)</span> <span class="c1"># remove old node from our list</span>
        <span class="n">this_node</span><span class="o">.</span><span class="n">remove_from_simulation</span><span class="p">()</span> <span class="c1"># remove old node from the simulation</span>

    <span class="c1">## Do user simulation here</span>
    <span class="c1">## main task: do BS association if needed</span>
    <span class="k">def</span> <span class="nf">do_mobility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">):</span>

        <span class="n">all_vehicles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span>    <span class="c1"># get all vehicles from our liist</span>
        <span class="n">all_sectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs_nodes</span>     <span class="c1"># get all sectors from our list</span>

        <span class="c1">## check vehicle connectivity with its associated BS</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span>
            <span class="n">my_sector</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">associated_sector</span>
            <span class="k">if</span> <span class="n">my_sector</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if none</span>

            <span class="n">beacon</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">unicast</span><span class="p">(</span><span class="n">beacon</span><span class="p">,</span><span class="n">my_sector</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># lost connection</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">lost_sector</span><span class="p">(</span><span class="n">sim_time</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;at t=</span><span class="si">%1.2f</span><span class="s2">, </span><span class="si">%s</span><span class="s2"> lost connection with </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">sim_time</span><span class="p">,</span><span class="n">vehicle</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">my_sector</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="c1">## main task: make associatiation with BS if needed</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span>

            <span class="c1">## step 1: check sector association, skip if already associated</span>
            <span class="k">if</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">associated_sector</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>

            <span class="c1">## step 2: find strongest SNR to associate</span>
            <span class="n">bs_max</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">detection_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">beacon</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
            <span class="n">reply_list</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">beacon</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">beam</span><span class="p">,</span><span class="n">signal</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reply_list</span><span class="p">:</span>
                <span class="c1">## 2.1 check that the reachable node is a BS sector currently not serving other</span>
                <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">type</span><span class="o">!=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">BaseStation</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if not BS sector</span>
                <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">serving_node</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if BS sector is already serving other</span>

                <span class="c1">## 2.2 sector beam replies beacon for vehicle to obtain the signal quality</span>
                <span class="n">beacon_reply</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
                <span class="n">recv_signal</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">unicast</span><span class="p">(</span><span class="n">beacon_reply</span><span class="p">,</span><span class="n">vehicle</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">recv_signal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if failed, likely not in coverage</span>

                <span class="c1">## 2.3 append to the detection list</span>
                <span class="n">detection_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">beam</span><span class="p">,</span><span class="n">recv_signal</span><span class="o">.</span><span class="n">quality</span><span class="p">))</span>

            <span class="c1">## step 3: associate with the BS with the strongest SNR, if exists</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">detection_list</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">bs_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">detection_list</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">bs_max</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">associate_sector</span><span class="p">(</span><span class="n">bs_max</span><span class="p">,</span><span class="n">sim_time</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;at t=</span><span class="si">%1.2f</span><span class="s2">, </span><span class="si">%s</span><span class="s2"> associated with </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">sim_time</span><span class="p">,</span><span class="n">vehicle</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">bs_max</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="c1">## check for interference for each vehicle</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span>

            <span class="c1">## skip if no BS association, probably outside of BS beam coverage</span>
            <span class="k">if</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">associated_sector</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>

            <span class="c1">## use hello-beacon to find which other beam also covers this vehicle</span>
            <span class="n">vehicle</span><span class="o">.</span><span class="n">has_interference</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">beacon</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
            <span class="n">reply_list</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">beacon</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">beam</span><span class="p">,</span><span class="n">signal</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reply_list</span><span class="p">:</span>

                <span class="c1">## check the bs beam</span>
                <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">type</span><span class="o">!=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">BaseStation</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if not BS</span>
                <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">serving_node</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>         <span class="c1"># skip if the bs is not active</span>
                <span class="k">if</span> <span class="n">beam</span><span class="o">==</span><span class="n">vehicle</span><span class="o">.</span><span class="n">associated_sector</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if it&#39;s the associated BS</span>

                <span class="c1">## at this point, the beam is associated with another vehicle</span>
                <span class="c1">## check that if it can also cover this vehicle</span>
                <span class="n">probe_message</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
                <span class="n">recv_signal</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">unicast</span><span class="p">(</span><span class="n">probe_message</span><span class="p">,</span><span class="n">vehicle</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">recv_signal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>      <span class="c1"># can probe signal reach the vehicle?</span>
                    <span class="n">vehicle</span><span class="o">.</span><span class="n">has_interference</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># if so, set interference to True</span>

        <span class="c1">## draw connectivity &amp; beam coverage on the map</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span>
            <span class="n">vehicle</span><span class="o">.</span><span class="n">show_connection</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">all_sectors</span><span class="p">:</span>
            <span class="n">beam</span><span class="o">.</span><span class="n">show_coverage</span><span class="p">()</span>


<span class="c1">####################################################################</span>
<span class="c1">## main</span>
<span class="c1">####################################################################</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1">## command line parameters</span>
    <span class="n">parser</span><span class="p">:</span> <span class="n">ArgumentParser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--nodisplay&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run in no GUI mode&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--step&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Mobility step time (in sec)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--speed&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Animation playback speed (x times)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--duration&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Simulation duration (in sec), -1 for non-stop&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Namespace</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1">## welcome info</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A Simple VANET Environment. Press [^C] to quit&quot;</span><span class="p">)</span>
    <span class="c1">#args.nodisplay = True  # &lt;-- hardcoding no GUI mode</span>
    <span class="n">args</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mf">0.1</span>         <span class="c1"># &lt;-- hardcoding the mobility step time</span>
    <span class="n">args</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mf">1.0</span>        <span class="c1"># &lt;-- hardcoding the animation speed (times)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>     <span class="c1"># &lt;-- hardcoding the sim duration (sec)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nodisplay</span><span class="p">:</span>   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- simulation will run without animation&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- animation will playback at x</span><span class="si">%1.2f</span><span class="s2"> speed&quot;</span><span class="o">%</span><span class="n">args</span><span class="o">.</span><span class="n">speed</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- vehicles move a step every </span><span class="si">%1.2f</span><span class="s2"> s in simulation&quot;</span><span class="o">%</span><span class="n">args</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">duration</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- simulation will stop at </span><span class="si">%1.2f</span><span class="s2"> s&quot;</span><span class="o">%</span><span class="n">args</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- simulation will run non-stop&quot;</span><span class="p">)</span>

    <span class="c1">## create, setup and run the simulation</span>
    <span class="c1">## note that to run a simulation, we need to create a &#39;scenario&#39;</span>
    <span class="n">run_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">run_flag</span><span class="p">:</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">World</span><span class="p">()</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">sim_stop</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> 
                <span class="n">sim_step</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> 
                <span class="n">sim_speed</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">speed</span><span class="p">,</span> 
                <span class="n">display_option</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">nodisplay</span><span class="p">,</span> 
                <span class="n">scenario</span> <span class="o">=</span> <span class="n">MyScenario</span><span class="p">(</span><span class="n">sim</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running PyMoSim version v</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">sim</span><span class="o">.</span><span class="n">version</span><span class="p">())</span>
        <span class="n">run_flag</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</details></div>
<div class="section" id="module-example4">
<span id="example-4"></span><h2>Example 4<a class="headerlink" href="#module-example4" title="Permalink to this headline">¶</a></h2>
<p>This is an example demonstrating a number of vehicles following random waypoint
mobility moving on the map which contains a number of sectorized small cell base 
stations. The simulation runs non-stop.</p>
<p>In this example, we use vehicle centric where vehicle will send a hello beacon message
to collect reply packet quality from all sectors of all BSs, and then associate with 
the sector with the highest quality (i.e. strongest SNR).</p>
<img alt="_images/example4.gif" src="_images/example4.gif" />
<details class="summary-show-source-code">
<summary>Show source code</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This is an example demonstrating a number of vehicles following random waypoint</span>
<span class="sd">mobility moving on the map which contains a number of sectorized small cell base </span>
<span class="sd">stations. The simulation runs non-stop.</span>

<span class="sd">In this example, we use vehicle centric where vehicle will send a hello beacon message</span>
<span class="sd">to collect reply packet quality from all sectors of all BSs, and then associate with </span>
<span class="sd">the sector with the highest quality (i.e. strongest SNR).</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">wx</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span><span class="p">,</span> <span class="n">ArgumentParser</span>
<span class="kn">from</span> <span class="nn">sim.simulation</span> <span class="kn">import</span> <span class="n">World</span>
<span class="kn">from</span> <span class="nn">sim.loc</span> <span class="kn">import</span> <span class="n">ScreenXY</span> <span class="k">as</span> <span class="n">XY</span>
<span class="kn">from</span> <span class="nn">sim.scenario</span> <span class="kn">import</span> <span class="n">BaseScenario</span>
<span class="kn">from</span> <span class="nn">node.node</span> <span class="kn">import</span> <span class="n">BaseNode</span>
<span class="kn">from</span> <span class="nn">node.mobility</span> <span class="kn">import</span> <span class="n">Stationary</span><span class="p">,</span> <span class="n">StaticPath</span>
<span class="kn">from</span> <span class="nn">comm.transceiver</span> <span class="kn">import</span> <span class="n">Transceiver</span><span class="p">,</span> <span class="n">TransceiverDir</span>
<span class="kn">from</span> <span class="nn">comm.channel</span> <span class="kn">import</span> <span class="n">DiscModel</span>
<span class="kn">from</span> <span class="nn">sim.event</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">import</span> <span class="nn">node.type</span> <span class="k">as</span> <span class="nn">NodeType</span>


<span class="c1">####################################################################</span>
<span class="c1">## Helper</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">DebugPrint</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="c1"># comment this line out to disable debug printing</span>
        <span class="k">pass</span>


<span class="c1">####################################################################</span>
<span class="c1">## Nodes</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">MySector</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MySector: This is a sector of a base station in the VANET sim world</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">sector_width</span><span class="p">,</span> <span class="n">sector_dir</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">BaseStation</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">TransceiverDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">freq</span><span class="p">,</span><span class="n">channel</span><span class="p">,</span><span class="n">sector_width</span><span class="p">,</span><span class="n">sector_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serving_node</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">## setup the sector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_transceiver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">Stationary</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>

    <span class="c1">## show the coverage of this sector</span>
    <span class="k">def</span> <span class="nf">show_coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_drawing</span><span class="p">()</span> <span class="c1"># this is persistent drawing, so need to clear the all first</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serving_node</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;omni&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw_circle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;directional&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw_sector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;azimuth&quot;</span><span class="p">),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;beam width&quot;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">MyVehicle</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MyVehicle: This is a transmitting node in the VANET sim world</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">Vehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="c1">## initialize some properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">Transceiver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">freq</span><span class="p">,</span><span class="n">channel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_transceiver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">## initialize some variables to collect statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectivity</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="c1"># list of connections: [sector, start_time, end_time]</span>

    <span class="c1">## associate with a sector</span>
    <span class="k">def</span> <span class="nf">associate_sector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sector</span><span class="p">,</span><span class="n">time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span> <span class="o">=</span> <span class="n">sector</span>
        <span class="n">sector</span><span class="o">.</span><span class="n">serving_node</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectivity</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sector</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1">## remove sector association due to lost of connection</span>
    <span class="k">def</span> <span class="nf">lost_sector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span><span class="o">.</span><span class="n">serving_node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectivity</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connectivity</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connectivity</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">20</span><span class="p">:</span> <span class="c1"># keep last 20 records</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connectivity</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 

    <span class="c1">## draw a line to the associated sector, if any</span>
    <span class="k">def</span> <span class="nf">show_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_drawing</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">associated_sector</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">BLACK</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span>


<span class="c1">####################################################################</span>
<span class="c1">## Scenario</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">MyScenario</span><span class="p">(</span><span class="n">BaseScenario</span><span class="p">,</span><span class="n">DebugPrint</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MyScenario: This is my scenario</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">## This method will be called before the start of the simulation,</span>
    <span class="c1">## build the simulation world here</span>
    <span class="k">def</span> <span class="nf">on_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>

        <span class="c1">## simulation title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;Dense Sectorized Small Cells&quot;</span><span class="p">)</span>

        <span class="c1">## simulation setup for beam</span>
        <span class="n">beam_radius</span> <span class="o">=</span> <span class="mi">80</span>
        <span class="n">beam_num</span> <span class="o">=</span> <span class="mi">6</span>     <span class="c1"># must be an integer</span>
        <span class="n">beam_width</span> <span class="o">=</span> <span class="mi">360</span><span class="o">/</span><span class="n">beam_num</span>
        <span class="n">beam_pointing</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 0 means north</span>

        <span class="c1">## simulation setup for map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_width</span> <span class="o">=</span> <span class="mi">500</span> <span class="c1"># pixels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_height</span> <span class="o">=</span> <span class="mi">300</span> <span class="c1"># pixels</span>

        <span class="c1">## simulation setup for nodes </span>
        <span class="n">bs_num</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1"># number of BSs to put on the map</span>
        <span class="n">car_num</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># number of vehicles to put on the map</span>

        <span class="c1">## simulation setup for channel</span>
        <span class="n">carrier_freq</span> <span class="o">=</span> <span class="mf">2.4</span>
        <span class="n">ch_omni</span> <span class="o">=</span> <span class="n">DiscModel</span><span class="p">(</span><span class="n">beam_radius</span><span class="p">)</span>
        <span class="n">sector_dir</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">beam_num</span><span class="p">):</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">beam_pointing</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">beam_width</span>
            <span class="k">while</span> <span class="n">angle</span><span class="o">&gt;=</span><span class="mi">360</span><span class="p">:</span> <span class="n">angle</span><span class="o">-=</span><span class="mi">360</span>
            <span class="n">sector_dir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

        <span class="c1">## create BSs and their sectors on the map at random locations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sector_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">bs_num</span><span class="p">):</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_random_loc</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">beam_num</span><span class="p">):</span> <span class="c1"># create sectors for each BS</span>
                <span class="n">this_id</span> <span class="o">=</span> <span class="s2">&quot;BS</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                <span class="n">this_node</span> <span class="o">=</span> <span class="n">MySector</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="n">this_id</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">carrier_freq</span><span class="p">,</span> <span class="n">ch_omni</span><span class="p">,</span> 
                                     <span class="n">beam_width</span><span class="p">,</span> <span class="n">sector_dir</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sector_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_node</span><span class="p">)</span>

        <span class="c1">## create some vehicles on the map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">car_num</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="mi">60</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_random_loc</span><span class="p">())</span> <span class="p">]</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">MyVehicle</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Vehicle</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="n">carrier_freq</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="n">ch_omni</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">StaticPath</span><span class="p">(</span><span class="n">start_loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_random_loc</span><span class="p">(),</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1">## generate a random location</span>
    <span class="k">def</span> <span class="nf">get_random_loc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_width</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_height</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">XY</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

    <span class="c1">## This method will be called repeatedly until the simulation is ended/stopped</span>
    <span class="k">def</span> <span class="nf">on_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">event_obj</span><span class="o">==</span><span class="n">Event</span><span class="o">.</span><span class="n">MOBILITY_END</span><span class="p">:</span> <span class="c1"># a mobile node has finished its mobility?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_create_path</span><span class="p">(</span><span class="n">sim_time</span><span class="p">,</span><span class="n">event_obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event_obj</span><span class="o">==</span><span class="n">Event</span><span class="o">.</span><span class="n">SIM_MOBILITY</span><span class="p">:</span> <span class="c1"># mobility progresses a time step?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_mobility</span><span class="p">(</span><span class="n">sim_time</span><span class="p">,</span><span class="n">event_obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">event_obj</span><span class="o">==</span><span class="n">Event</span><span class="o">.</span><span class="n">SIM_END</span>
              <span class="ow">or</span> <span class="n">event_obj</span><span class="o">==</span><span class="n">Event</span><span class="o">.</span><span class="n">SIM_STOP</span><span class="p">):</span> <span class="c1"># end of simulation?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_statistics</span><span class="p">()</span>

    <span class="c1">## create a new path for the node</span>
    <span class="k">def</span> <span class="nf">do_create_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">):</span>
        <span class="n">speed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span> <span class="c1"># random speed</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_random_loc</span><span class="p">()</span>   <span class="c1"># random location</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">event_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mobility&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_path</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span><span class="n">loc</span><span class="p">)</span>

    <span class="c1">## Do user simulation here</span>
    <span class="k">def</span> <span class="nf">do_mobility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">):</span>

        <span class="n">all_vehicles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span>
        <span class="n">all_sectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sector_nodes</span>

        <span class="c1">## check vehicle connectivity with its associated sector</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span>
            <span class="n">my_sector</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">associated_sector</span>
            <span class="k">if</span> <span class="n">my_sector</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if none</span>

            <span class="n">beacon</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">unicast</span><span class="p">(</span><span class="n">beacon</span><span class="p">,</span><span class="n">my_sector</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># lost connection</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">lost_sector</span><span class="p">(</span><span class="n">sim_time</span><span class="p">)</span>

        <span class="c1">## make associatiation with sector if needed</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span>

            <span class="c1">## step 1: check BS sector association, skip if already associated</span>
            <span class="k">if</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">associated_sector</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>

            <span class="c1">## step 2: find strongest SNR to associate</span>
            <span class="n">sector_max</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">detection_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">beacon</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
            <span class="n">reply_list</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">beacon</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">sector</span><span class="p">,</span><span class="n">signal</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reply_list</span><span class="p">:</span>
                <span class="c1">## 2.1 check that the reachable node is a BS currently not serving other</span>
                <span class="k">if</span> <span class="n">sector</span><span class="o">.</span><span class="n">type</span><span class="o">!=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">BaseStation</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if not a base station type</span>
                <span class="k">if</span> <span class="n">sector</span><span class="o">.</span><span class="n">serving_node</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if sector is already serving other</span>

                <span class="c1">## 2.2 sector beam replies beacon for vehicle to obtain the signal quality</span>
                <span class="n">beacon_reply</span> <span class="o">=</span> <span class="n">sector</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
                <span class="n">recv_signal</span> <span class="o">=</span> <span class="n">sector</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">unicast</span><span class="p">(</span><span class="n">beacon_reply</span><span class="p">,</span><span class="n">vehicle</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">recv_signal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if failed, likely not in coverage</span>

                <span class="c1">## 2.3 append to the detection list</span>
                <span class="n">detection_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sector</span><span class="p">,</span><span class="n">recv_signal</span><span class="o">.</span><span class="n">quality</span><span class="p">))</span>

            <span class="c1">## step 3: associate with the BS sector with the strongest SNR, if exists</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">detection_list</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">sector_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">detection_list</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sector_max</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">associate_sector</span><span class="p">(</span><span class="n">sector_max</span><span class="p">,</span><span class="n">sim_time</span><span class="p">)</span>

        <span class="c1">## draw connectivity &amp; sector coverage on the map</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span>
            <span class="n">vehicle</span><span class="o">.</span><span class="n">show_connection</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sector</span> <span class="ow">in</span> <span class="n">all_sectors</span><span class="p">:</span>
            <span class="n">sector</span><span class="o">.</span><span class="n">show_coverage</span><span class="p">()</span>


    <span class="c1">## This method prints statistics of the connectivity durations</span>
    <span class="c1">## This should be called at the end of the simulation</span>
    <span class="k">def</span> <span class="nf">print_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Statistics (last 20 connected BSs and the duration):&quot;</span><span class="p">)</span>
        <span class="n">all_vehicles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span>

        <span class="n">conn_info_all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">average_all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span> <span class="c1"># get statistics into `conn_info_all[]`</span>
            <span class="n">conn_info_each</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sum_duration</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">connection_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">connectivity</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">conn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">conn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">duration</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># unfinished record (due to sim_end)</span>
                <span class="n">conn_info_each</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">conn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">duration</span><span class="p">])</span>
                <span class="n">sum_duration</span> <span class="o">+=</span> <span class="n">duration</span>
                <span class="n">connection_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">conn_info_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conn_info_each</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">connection_count</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">average_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sum_duration</span><span class="o">/</span><span class="n">connection_count</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">average_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">print_fixed</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">text</span><span class="si">:</span><span class="s2">15</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span> <span class="c1"># line 1, heading</span>
            <span class="n">print_fixed</span><span class="p">(</span><span class="n">vehicle</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">max_record</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span> <span class="c1"># line 2, separator</span>
            <span class="n">print_fixed</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">vehicle</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">conn_info_all</span><span class="p">:</span> <span class="c1"># line 3..., connection info</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">)</span><span class="o">&gt;</span><span class="n">max_record</span><span class="p">:</span>
                <span class="n">max_record</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">max_record</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">vnode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">conn_info_all</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">idx</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">conn_info_all</span><span class="p">[</span><span class="n">vnode</span><span class="p">]):</span>
                    <span class="n">print_fixed</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%1.2f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">conn_info_all</span><span class="p">[</span><span class="n">vnode</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="n">conn_info_all</span><span class="p">[</span><span class="n">vnode</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">print_fixed</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">all_vehicles</span><span class="p">:</span>  <span class="c1"># 2nd last line, separator</span>
            <span class="n">print_fixed</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">vehicle</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">average</span> <span class="ow">in</span> <span class="n">average_all</span><span class="p">:</span>   <span class="c1"># last line, average values</span>
            <span class="n">print_fixed</span><span class="p">(</span><span class="s2">&quot;Mean=</span><span class="si">%1.2f</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">average</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>


<span class="c1">####################################################################</span>
<span class="c1">## main</span>
<span class="c1">####################################################################</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1">## command line parameters</span>
    <span class="n">parser</span><span class="p">:</span> <span class="n">ArgumentParser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--nodisplay&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run in no GUI mode&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--step&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Mobility step time (in sec)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--speed&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Animation playback speed (x times)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--duration&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Simulation duration (in sec)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Namespace</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1">## welcome info</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A Simple VANET Environment. Press [^C] to quit&quot;</span><span class="p">)</span>
    <span class="c1">#args.nodisplay = True  # &lt;-- hardcoding no GUI mode</span>
    <span class="n">args</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mf">0.1</span>         <span class="c1"># &lt;-- hardcoding the mobility step time</span>
    <span class="n">args</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mf">1.0</span>        <span class="c1"># &lt;-- hardcoding the animation speed (times)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>      <span class="c1"># &lt;-- hardcoding the sim duration (sec)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nodisplay</span><span class="p">:</span>   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- simulation will run without animation&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- animation will playback at x</span><span class="si">%1.2f</span><span class="s2"> speed&quot;</span><span class="o">%</span><span class="n">args</span><span class="o">.</span><span class="n">speed</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- vehicles move a step every </span><span class="si">%1.2f</span><span class="s2"> s in simulation&quot;</span><span class="o">%</span><span class="n">args</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">duration</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- simulation will stop at </span><span class="si">%1.2f</span><span class="s2"> s&quot;</span><span class="o">%</span><span class="n">args</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- simulation will run non-stop&quot;</span><span class="p">)</span>

    <span class="c1">## create, setup and run the simulation</span>
    <span class="c1">## note that to run a simulation, we need to create a &#39;scenario&#39;</span>
    <span class="n">run_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">run_flag</span><span class="p">:</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">World</span><span class="p">()</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">sim_stop</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> 
                <span class="n">sim_step</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> 
                <span class="n">sim_speed</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">speed</span><span class="p">,</span> 
                <span class="n">display_option</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">nodisplay</span><span class="p">,</span> 
                <span class="n">scenario</span> <span class="o">=</span> <span class="n">MyScenario</span><span class="p">(</span><span class="n">sim</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running PyMoSim version v</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">sim</span><span class="o">.</span><span class="n">version</span><span class="p">())</span>
        <span class="n">run_flag</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        
</pre></div>
</div>
</details></div>
<div class="section" id="module-example5">
<span id="example-5"></span><h2>Example 5<a class="headerlink" href="#module-example5" title="Permalink to this headline">¶</a></h2>
<p>This example demonstrates the use of <a class="reference internal" href="comm.transceiver.html#comm.transceiver.UserTransceiver" title="comm.transceiver.UserTransceiver"><code class="xref py py-class docutils literal notranslate"><span class="pre">comm.transceiver.UserTransceiver</span></code></a>.
It uses <a class="reference internal" href="comm.signalwave.html#comm.signalwave.QualityBasedSignal" title="comm.signalwave.QualityBasedSignal"><code class="xref py py-class docutils literal notranslate"><span class="pre">comm.signalwave.QualityBasedSignal</span></code></a> for transmission. It 
illustrates how users can implement own signal propagation and detection logic.</p>
<p>In this example, we have two moving vehicles and we let the base station 
(BS) connect to both if they can detect the signal from the BS. 
This example shows how signal propagation and detection logic can be 
implemented at the user simulation level if users need some special treatment 
and full control of signal propagation and signal detection logic.</p>
<p>We assume that the BS can track vehicles. The channel model is based on <a class="reference internal" href="example5.html#r0c1842856b50-wfy20" id="id1">[WFY20]</a>.</p>
<div class="section" id="references">
<h3>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h3>
<dl class="citation">
<dt class="label" id="r0c1842856b50-wfy20"><span class="brackets"><a class="fn-backref" href="#id1">WFY20</a></span></dt>
<dd><p>P. Wang, J. Fang, X. Yuan, Z. Chen, and H. Li, “Intelligent 
reflecting surface-assisted millimeter wave communications: Joint 
active and passive precoding design,” IEEE Transactions on Vehicular 
Technology, vol. 69, no. 12, pp. 14960-14973, 2020.</p>
</dd>
</dl>
</div>
<img alt="_images/example5.gif" src="_images/example5.gif" />
<details class="summary-show-source-code">
<summary>Show source code</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This example demonstrates the use of :class:`comm.transceiver.UserTransceiver`.</span>
<span class="sd">It uses :class:`comm.signalwave.QualityBasedSignal` for transmission. It </span>
<span class="sd">illustrates how users can implement own signal propagation and detection logic.</span>

<span class="sd">In this example, we have two moving vehicles and we let the base station </span>
<span class="sd">(BS) connect to both if they can detect the signal from the BS. </span>
<span class="sd">This example shows how signal propagation and detection logic can be </span>
<span class="sd">implemented at the user simulation level if users need some special treatment </span>
<span class="sd">and full control of signal propagation and signal detection logic.</span>

<span class="sd">We assume that the BS can track vehicles. The channel model is based on [WFY20]_.</span>

<span class="sd">References</span>
<span class="sd">----------</span>
<span class="sd">.. [WFY20] P. Wang, J. Fang, X. Yuan, Z. Chen, and H. Li, &quot;Intelligent </span>
<span class="sd">    reflecting surface-assisted millimeter wave communications: Joint </span>
<span class="sd">    active and passive precoding design,&quot; IEEE Transactions on Vehicular </span>
<span class="sd">    Technology, vol. 69, no. 12, pp. 14960-14973, 2020.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">wx</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span><span class="p">,</span> <span class="n">ArgumentParser</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="nn">sim.simulation</span> <span class="kn">import</span> <span class="n">World</span>
<span class="kn">from</span> <span class="nn">sim.loc</span> <span class="kn">import</span> <span class="n">ScreenXY</span> <span class="k">as</span> <span class="n">XY</span>
<span class="kn">from</span> <span class="nn">sim.direction</span> <span class="kn">import</span> <span class="n">Dir2D</span>
<span class="kn">from</span> <span class="nn">sim.scenario</span> <span class="kn">import</span> <span class="n">BaseScenario</span>
<span class="kn">from</span> <span class="nn">sim.drawable</span> <span class="kn">import</span> <span class="n">Drawable</span>
<span class="kn">from</span> <span class="nn">node.node</span> <span class="kn">import</span> <span class="n">BaseNode</span>
<span class="kn">from</span> <span class="nn">node.mobility</span> <span class="kn">import</span> <span class="n">Stationary</span><span class="p">,</span> <span class="n">StaticPath</span>
<span class="kn">from</span> <span class="nn">comm.transceiver</span> <span class="kn">import</span> <span class="n">UserTransceiver</span>
<span class="kn">from</span> <span class="nn">node.obstacle</span> <span class="kn">import</span> <span class="n">Obstacle</span>
<span class="kn">import</span> <span class="nn">node.type</span> <span class="k">as</span> <span class="nn">NodeType</span>

<span class="c1">####################################################################</span>
<span class="c1">## My Transceiver</span>
<span class="c1">## - Perform own signal propagation and detection logic</span>
<span class="c1">## - Aware of an obstacle</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">MyTransceiver</span><span class="p">(</span><span class="n">UserTransceiver</span><span class="p">):</span>

    <span class="c1">## class constants or default values</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="o">-</span><span class="mi">90</span> <span class="c1"># dBm</span>
    <span class="n">snr_threshold</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># dB</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">tx_power</span><span class="p">,</span> <span class="n">ant_element</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="n">freq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obstacle_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx_power</span> <span class="o">=</span> <span class="n">tx_power</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ant_element</span> <span class="o">=</span> <span class="n">ant_element</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snr_threshold</span> <span class="o">=</span> <span class="n">MyTransceiver</span><span class="o">.</span><span class="n">snr_threshold</span>

    <span class="k">def</span> <span class="nf">create_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_power</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Use this method to create a signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tx_power : float</span>
<span class="sd">            The transmit power of the signal.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`comm.signalwave.QualityBasedSignal`</span>
<span class="sd">            The created signal to be used for transmission.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tx_power</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">tx_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx_power</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">add_info</span><span class="p">(</span><span class="s2">&quot;ant element&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ant_element</span><span class="p">)</span> <span class="c1"># number of antenna elements</span>
        <span class="k">return</span> <span class="n">signal</span>

    <span class="k">def</span> <span class="nf">set_obstacle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obstacle_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obstacle_list</span> <span class="o">=</span> <span class="n">obstacle_list</span>

    <span class="k">def</span> <span class="nf">is_crossed_obstacle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_loc</span><span class="p">,</span> <span class="n">rx_loc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obstacle_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="n">point1</span> <span class="o">=</span> <span class="n">tx_loc</span><span class="o">.</span><span class="n">get_xy</span><span class="p">()</span>
        <span class="n">point2</span> <span class="o">=</span> <span class="n">rx_loc</span><span class="o">.</span><span class="n">get_xy</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">obstacle_list</span><span class="o">.</span><span class="n">is_crossed</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span><span class="n">point2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">can_detect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">the_signal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;This is the function to perform signal propagation and</span>
<span class="sd">        detection logic.&#39;&#39;&#39;</span>

        <span class="c1">## retrieve all key info first</span>
        <span class="n">tx_power</span> <span class="o">=</span> <span class="n">the_signal</span><span class="o">.</span><span class="n">tx_power</span>      <span class="c1"># get the tx power in dBm</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">the_signal</span><span class="o">.</span><span class="n">distance</span>      <span class="c1"># get the distance travelled</span>
        <span class="n">travelling_dir</span> <span class="o">=</span> <span class="n">the_signal</span><span class="o">.</span><span class="n">LOS_dir</span> <span class="c1"># get the travelling direction</span>
        <span class="n">tx_loc</span> <span class="o">=</span> <span class="n">the_signal</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">)</span> <span class="c1"># sender location</span>
        <span class="n">rx_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">)</span>              <span class="c1"># receiver location</span>

        <span class="c1">## check if signal is crossing obstacle</span>
        <span class="n">is_crossed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_crossed_obstacle</span><span class="p">(</span><span class="n">tx_loc</span><span class="p">,</span><span class="n">rx_loc</span><span class="p">)</span>

        <span class="c1">## apply simple passloss model c0*d^(-α), where</span>
        <span class="c1">#  - d is the distance, in our system, 2 pixels = 1m, minimum 1m</span>
        <span class="c1">#  - α is the pathloss exponent, 2 for normal, 2.92 when crossing an obstacle</span>
        <span class="c1">#  - c0 is the gain/loss</span>
        <span class="c1">## pathloss PL_db = log10(c0) + 10α*log10(d)</span>
        <span class="n">distance</span> <span class="o">/=</span> <span class="mi">2</span>             <span class="c1"># convert pixel-to-meter</span>
        <span class="k">if</span> <span class="n">distance</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">distance</span><span class="o">=</span><span class="mi">1</span> <span class="c1"># min 1m</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_crossed</span> <span class="k">else</span> <span class="mf">2.92</span>   <span class="c1"># set pathloss exponent</span>
        <span class="n">log_c0</span> <span class="o">=</span> <span class="mf">61.4</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_crossed</span> <span class="k">else</span> <span class="mi">72</span> <span class="c1"># set loss</span>
        <span class="n">pathloss_db</span> <span class="o">=</span> <span class="n">log_c0</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>

        <span class="c1">## received power including the gain from the number of antenna elements</span>
        <span class="n">ant_element_num</span> <span class="o">=</span> <span class="n">the_signal</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="s2">&quot;ant element&quot;</span><span class="p">)</span>
        <span class="n">received_power</span> <span class="o">=</span> <span class="n">tx_power</span> <span class="o">-</span> <span class="n">pathloss_db</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ant_element_num</span><span class="p">)</span>

        <span class="c1">## check if the signal is detectable, i.e. its SNR</span>
        <span class="c1">## exceeds the threshold (default setting, see `MyTransceiver.snr_threshold`)</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="n">received_power</span><span class="o">-</span><span class="n">MyTransceiver</span><span class="o">.</span><span class="n">noise</span>
        <span class="k">if</span> <span class="n">snr</span><span class="o">&gt;=</span><span class="n">MyTransceiver</span><span class="o">.</span><span class="n">snr_threshold</span><span class="p">:</span> 
            <span class="n">the_signal</span><span class="o">.</span><span class="n">quality</span> <span class="o">=</span> <span class="n">received_power</span>
            <span class="n">the_signal</span><span class="o">.</span><span class="n">add_info</span><span class="p">(</span><span class="s2">&quot;crossed_obstacle&quot;</span><span class="p">,</span><span class="n">is_crossed</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span> <span class="c1"># can detect</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">the_signal</span><span class="o">.</span><span class="n">quality</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="kc">False</span> <span class="c1"># cannot detect</span>

<span class="k">class</span> <span class="nc">MyTransceiverBS</span><span class="p">(</span><span class="n">MyTransceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span> <span class="n">tx_power</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">ant_element</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyTransceiverVehicle</span><span class="p">(</span><span class="n">MyTransceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span> <span class="n">tx_power</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">ant_element</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">####################################################################</span>
<span class="c1">## Nodes</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">MyBS</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MyBS: This is a base station in the VANET sim world implementing </span>
<span class="sd">    a user-defined transceiver.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">BaseStation</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">MyTransceiverBS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1">## setup the BS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_transceiver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">Stationary</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">MyVehicle</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MyVehicle: This is a transmitting node in the VANET sim world implementing </span>
<span class="sd">    a user-defined transceiver.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">Vehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="c1">## initialize some properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">MyTransceiverVehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_transceiver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">associated_bs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_quality</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crossed_obstacle</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">## draw a line to the connected BS, if any</span>
    <span class="k">def</span> <span class="nf">show_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_drawing</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_bs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">associated_bs</span><span class="o">.</span><span class="n">clear_drawing</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crossed_obstacle</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">associated_bs</span><span class="p">,</span><span class="n">pen</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Pen</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">BLUE</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">PENSTYLE_SHORT_DASH</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">BLUE</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw_text</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="s2">&quot;Non-LOS: </span><span class="si">%1.2f</span><span class="s2">dB&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_quality</span><span class="o">-</span><span class="n">MyTransceiver</span><span class="o">.</span><span class="n">noise</span><span class="p">),</span>
                                <span class="n">wx</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">FONTFAMILY_ROMAN</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">FONTSTYLE_NORMAL</span><span class="p">,</span> 
                                            <span class="n">wx</span><span class="o">.</span><span class="n">FONTWEIGHT_NORMAL</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">associated_bs</span><span class="p">,</span><span class="n">pen</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Pen</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">BLACK</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">PENSTYLE_SOLID</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">BLACK</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw_text</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="s2">&quot;LOS: </span><span class="si">%1.2f</span><span class="s2">dB&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_quality</span><span class="o">-</span><span class="n">MyTransceiver</span><span class="o">.</span><span class="n">noise</span><span class="p">),</span>
                                <span class="n">wx</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">FONTFAMILY_ROMAN</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">FONTSTYLE_NORMAL</span><span class="p">,</span> 
                                            <span class="n">wx</span><span class="o">.</span><span class="n">FONTWEIGHT_NORMAL</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_text</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="s2">&quot;No Signal&quot;</span><span class="p">,</span>
                            <span class="n">wx</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">FONTFAMILY_ROMAN</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">FONTSTYLE_NORMAL</span><span class="p">,</span> 
                                        <span class="n">wx</span><span class="o">.</span><span class="n">FONTWEIGHT_NORMAL</span><span class="p">))</span>


<span class="c1">####################################################################</span>
<span class="c1">## Scenario</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">MyScenario</span><span class="p">(</span><span class="n">BaseScenario</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MyScenario: This is my scenario.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">##---------------------------------------------------------------</span>
    <span class="c1">## This method will be called before the start of the simulation,</span>
    <span class="c1">## build the simulation world here</span>
    <span class="k">def</span> <span class="nf">on_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>

        <span class="c1">## give a name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;A vehicle passing by a BS with some obstacles&quot;</span><span class="p">)</span>

        <span class="c1">## create two obstacles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_obstacle_list</span> <span class="o">=</span> <span class="n">Obstacle</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_obstacle_list</span><span class="o">.</span><span class="n">add_rect</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">260</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_obstacle_list</span><span class="o">.</span><span class="n">add_rect</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">each_block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_obstacle_list</span><span class="o">.</span><span class="n">get_list</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_drawable</span><span class="p">(</span><span class="n">Drawable</span><span class="p">()</span><span class="o">.</span><span class="n">polygon</span><span class="p">(</span><span class="n">each_block</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">set_drawing</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">BLUE_PEN</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">YELLOW_BRUSH</span><span class="p">))</span>

        <span class="c1">## create a BS on the map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="n">MyBS</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="s2">&quot;BS&quot;</span><span class="p">,</span> <span class="n">XY</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span><span class="mi">50</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">set_obstacle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_obstacle_list</span><span class="p">)</span>

        <span class="c1">## create several passing vehicles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">XY</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">210</span><span class="p">)),</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">XY</span><span class="p">(</span><span class="mi">450</span><span class="p">,</span><span class="mi">210</span><span class="p">))</span> <span class="p">]</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">MyVehicle</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="s2">&quot;Vehicle1&quot;</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">StaticPath</span><span class="p">(</span><span class="n">start_loc</span><span class="o">=</span><span class="n">XY</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">210</span><span class="p">),</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">))</span>
        <span class="n">node</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">set_obstacle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_obstacle_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">XY</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">245</span><span class="p">)),</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">XY</span><span class="p">(</span><span class="mi">450</span><span class="p">,</span><span class="mi">245</span><span class="p">))</span> <span class="p">]</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">MyVehicle</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="s2">&quot;Vehicle2&quot;</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">StaticPath</span><span class="p">(</span><span class="n">start_loc</span><span class="o">=</span><span class="n">XY</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">245</span><span class="p">),</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">))</span>
        <span class="n">node</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">set_obstacle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_obstacle_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1">##-------------------------------------------------------------</span>
    <span class="c1">## This method will be called repeatedly until the simulation</span>
    <span class="c1">## is ended or stopped, perform any user simulation action here</span>
    <span class="k">def</span> <span class="nf">on_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">):</span>

        <span class="c1">## BS transmission to vehicles</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="p">:</span>

            <span class="c1">## send a packet to the tracked vehicle</span>
            <span class="n">packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
            <span class="n">recv_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">unicast</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span><span class="n">vehicle</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">recv_signal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">associated_bs</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">connection_quality</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">associated_bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">connection_quality</span> <span class="o">=</span> <span class="n">recv_signal</span><span class="o">.</span><span class="n">quality</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">crossed_obstacle</span> <span class="o">=</span> <span class="n">recv_signal</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="s2">&quot;crossed_obstacle&quot;</span><span class="p">)</span>

        <span class="c1">## show connections</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="p">:</span>
            <span class="n">vehicle</span><span class="o">.</span><span class="n">show_connection</span><span class="p">()</span>

<span class="c1">####################################################################</span>
<span class="c1">## main</span>
<span class="c1">####################################################################</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1">## command line parameters</span>
    <span class="n">parser</span><span class="p">:</span> <span class="n">ArgumentParser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--nodisplay&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run in no GUI mode&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--step&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Mobility step time (in sec)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--speed&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Animation playback speed (x times)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--duration&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Simulation duration (in sec), -1 for non-stop&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Namespace</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1">## welcome info</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A Simple VANET Environment. Press [^C] to quit&quot;</span><span class="p">)</span>
    <span class="c1">#args.nodisplay = True  # &lt;-- hardcoding no GUI mode</span>
    <span class="n">args</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mf">0.1</span>         <span class="c1"># &lt;-- hardcoding the mobility step time</span>
    <span class="n">args</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mf">1.0</span>        <span class="c1"># &lt;-- hardcoding the animation speed (times)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mf">15.0</span>     <span class="c1"># &lt;-- hardcoding the sim duration (sec)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nodisplay</span><span class="p">:</span>   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- simulation will run without animation&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- animation will playback at x</span><span class="si">%1.2f</span><span class="s2"> speed&quot;</span><span class="o">%</span><span class="n">args</span><span class="o">.</span><span class="n">speed</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- vehicles move a step every </span><span class="si">%1.2f</span><span class="s2"> s in simulation&quot;</span><span class="o">%</span><span class="n">args</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">duration</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- simulation will stop at </span><span class="si">%1.2f</span><span class="s2"> s&quot;</span><span class="o">%</span><span class="n">args</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- simulation will run non-stop&quot;</span><span class="p">)</span>

    <span class="c1">## create, setup and run the simulation</span>
    <span class="c1">## note that to run a simulation, we need to create a &#39;scenario&#39;</span>
    <span class="n">run_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">run_flag</span><span class="p">:</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">World</span><span class="p">()</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">sim_stop</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> 
                <span class="n">sim_step</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> 
                <span class="n">sim_speed</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">speed</span><span class="p">,</span> 
                <span class="n">display_option</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">nodisplay</span><span class="p">,</span> 
                <span class="n">scenario</span> <span class="o">=</span> <span class="n">MyScenario</span><span class="p">(</span><span class="n">sim</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running PyMoSim version v</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">sim</span><span class="o">.</span><span class="n">version</span><span class="p">())</span>
        <span class="n">run_flag</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</details></div>
<div class="section" id="module-example6">
<span id="example-6"></span><h2>Example 6<a class="headerlink" href="#module-example6" title="Permalink to this headline">¶</a></h2>
<p>This is an example demonstrating how to load a map and perform some mobility. The program 
uses the built-in path-finding algorithm (i.e. A*STAR) to establish routes for vehicles.
This example introduces the following features:</p>
<ul class="simple">
<li><p>How to use a map for the simulation, including accessing the pins defined in the map.</p></li>
<li><p>How to create vehicles that move on the map given specific start and end locations. 
This example uses <a class="reference internal" href="node.mobility.html#node.mobility.StaticPath" title="node.mobility.StaticPath"><code class="xref py py-class docutils literal notranslate"><span class="pre">node.mobility.StaticPath</span></code></a> which is a static path mobility.
For this mobility, vehicles move independently where they simply ignore other 
vehicles on the same road, and hence vehicles can and will overlap with others when 
moving on the map.</p></li>
</ul>
<p>In this example, we use base station (BS) centric where a BS will send a beacon message
to collect reply packy quality from all vehicles, and then associate with the vehicle 
with the highest quality (i.e. strongest SNR).</p>
<img alt="_images/example6.gif" src="_images/example6.gif" />
<details class="summary-show-source-code">
<summary>Show source code</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This is an example demonstrating how to load a map and perform some mobility. The program </span>
<span class="sd">uses the built-in path-finding algorithm (i.e. A*STAR) to establish routes for vehicles.</span>
<span class="sd">This example introduces the following features:</span>

<span class="sd">- How to use a map for the simulation, including accessing the pins defined in the map.</span>
<span class="sd">- How to create vehicles that move on the map given specific start and end locations. </span>
<span class="sd">  This example uses :class:`node.mobility.StaticPath` which is a static path mobility.</span>
<span class="sd">  For this mobility, vehicles move independently where they simply ignore other </span>
<span class="sd">  vehicles on the same road, and hence vehicles can and will overlap with others when </span>
<span class="sd">  moving on the map.</span>

<span class="sd">In this example, we use base station (BS) centric where a BS will send a beacon message</span>
<span class="sd">to collect reply packy quality from all vehicles, and then associate with the vehicle </span>
<span class="sd">with the highest quality (i.e. strongest SNR).</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">wx</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">sim.simulation</span> <span class="kn">import</span> <span class="n">World</span>
<span class="kn">from</span> <span class="nn">sim.loc</span> <span class="kn">import</span> <span class="n">ScreenXY</span> <span class="k">as</span> <span class="n">XY</span>
<span class="kn">from</span> <span class="nn">sim.scenario</span> <span class="kn">import</span> <span class="n">BaseScenario</span>
<span class="kn">from</span> <span class="nn">sim.event</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">node.node</span> <span class="kn">import</span> <span class="n">BaseNode</span>
<span class="kn">from</span> <span class="nn">node.mobility</span> <span class="kn">import</span> <span class="n">Stationary</span><span class="p">,</span> <span class="n">StaticPath</span>
<span class="kn">from</span> <span class="nn">comm.transceiver</span> <span class="kn">import</span> <span class="n">Transceiver</span>
<span class="kn">from</span> <span class="nn">comm.channel</span> <span class="kn">import</span> <span class="n">DiscModel</span>
<span class="kn">from</span> <span class="nn">map.mapinfo</span> <span class="kn">import</span> <span class="n">MapInfo</span>
<span class="kn">import</span> <span class="nn">node.type</span> <span class="k">as</span> <span class="nn">NodeType</span>


<span class="c1">####################################################################</span>
<span class="c1">## Base station &amp; Vehicle</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">MyBS</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;MyBS: This is a base station design.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">BaseStation</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">Transceiver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">freq</span><span class="p">,</span><span class="n">channel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">serving_node</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">## setup BS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_transceiver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">Stationary</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">lost_vehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serving_node</span><span class="o">.</span><span class="n">lost_bs</span><span class="p">(</span><span class="n">sim_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serving_node</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">connect_vehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serving_node</span> <span class="o">=</span> <span class="n">vehicle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serving_node</span><span class="o">.</span><span class="n">connect_bs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_drawing</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serving_node</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_circle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coverage</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyVehicle</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;MyVehicle: This is a vehicle design.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">Vehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">Transceiver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">freq</span><span class="p">,</span><span class="n">channel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_transceiver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="nb">map</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">associated_bs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">set_route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_pin</span><span class="p">,</span> <span class="n">end_pin</span><span class="p">,</span> <span class="n">speed_low</span><span class="p">,</span> <span class="n">speed_high</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">find_path</span><span class="p">(</span><span class="n">start_pin</span><span class="p">,</span><span class="n">end_pin</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span> <span class="c1"># can&#39;t find a path</span>

        <span class="n">route</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># unpack the starting point</span>
        <span class="n">start_loc</span> <span class="o">=</span> <span class="n">XY</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="c1"># create an XY point</span>
        <span class="n">speed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">speed_low</span><span class="p">,</span><span class="n">speed_high</span><span class="p">)</span>   <span class="c1"># in km/h</span>
        <span class="n">speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">kph</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="n">speed_up_factor</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># in pixels/sec</span>
        <span class="k">for</span> <span class="n">waypoint</span> <span class="ow">in</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">route</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">speed</span><span class="p">,</span><span class="n">XY</span><span class="p">(</span><span class="n">waypoint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">waypoint</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">StaticPath</span><span class="p">(</span><span class="n">start_loc</span><span class="p">,</span><span class="n">route</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_pin</span> <span class="o">=</span> <span class="n">end_pin</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">lost_bs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_bs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">connect_bs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_bs</span> <span class="o">=</span> <span class="n">bs</span>

    <span class="k">def</span> <span class="nf">show_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_drawing</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_bs</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">associated_bs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">BLACK</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span>

<span class="c1">####################################################################</span>
<span class="c1">## Scenario setup</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">MyScenario</span><span class="p">(</span><span class="n">BaseScenario</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This is MyScenario. It reimplements on_create() and on_event().&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">on_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> <span class="c1"># this will be called at the start</span>

        <span class="c1">## load the map image and info</span>
        <span class="nb">map</span> <span class="o">=</span> <span class="n">MapInfo</span><span class="p">()</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">image_file</span><span class="o">=</span><span class="s2">&quot;Guildford-UK.png&quot;</span><span class="p">,</span>
                      <span class="n">data_file</span><span class="o">=</span><span class="s2">&quot;Guildford-UK.json&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">map</span><span class="o">.</span><span class="n">is_ready</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to load the map. The reason is: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">map</span><span class="o">.</span><span class="n">get_err_str</span><span class="p">())</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1">## use the map and give a name to this scenario</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_map</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;Vehicle Mobility in Guildford, Surrey, UK&quot;</span><span class="p">)</span>

        <span class="c1">## load some pin location info from the map to place the BSs</span>
        <span class="n">bs_loc</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;BS-1&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;BS-2&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;BS-3&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;BS-4&quot;</span><span class="p">:</span> <span class="kc">None</span> <span class="p">}</span>
        <span class="k">for</span> <span class="n">pin_name</span> <span class="ow">in</span> <span class="n">bs_loc</span><span class="p">:</span>
            <span class="n">bs_loc</span><span class="p">[</span><span class="n">pin_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">get_pin_xy</span><span class="p">(</span><span class="n">pin_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bs_loc</span><span class="p">[</span><span class="n">pin_name</span><span class="p">]</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to load this pin: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="o">%</span><span class="n">pin_name</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1">## create BSs at those loaded locations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_bs_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">carrier_freq</span> <span class="o">=</span> <span class="mf">2.4</span>
        <span class="n">ch_omni</span> <span class="o">=</span> <span class="n">DiscModel</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="nb">map</span><span class="o">.</span><span class="n">km</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">pin_name</span> <span class="ow">in</span> <span class="n">bs_loc</span><span class="p">:</span>
            <span class="n">new_bs</span> <span class="o">=</span> <span class="n">MyBS</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="n">pin_name</span><span class="p">,</span> <span class="n">XY</span><span class="p">(</span><span class="n">xy</span><span class="o">=</span><span class="n">bs_loc</span><span class="p">[</span><span class="n">pin_name</span><span class="p">]),</span> <span class="n">carrier_freq</span><span class="p">,</span> <span class="n">ch_omni</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_bs_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_bs</span><span class="p">)</span>

        <span class="c1">## create some vehicles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_vehicles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parking</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;NorthStreetParking&quot;</span><span class="p">,</span> <span class="s2">&quot;GuildfordStationParking&quot;</span><span class="p">,</span> 
                         <span class="s2">&quot;SpectrumParking&quot;</span><span class="p">,</span>    <span class="s2">&quot;Lido&quot;</span><span class="p">,</span> 
                         <span class="s2">&quot;G-LiveParking&quot;</span><span class="p">,</span>      <span class="s2">&quot;6GIC&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;TescoParking&quot;</span><span class="p">,</span>       <span class="s2">&quot;FortRoad&quot;</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">this_vehicle</span> <span class="o">=</span> <span class="n">MyVehicle</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="s2">&quot;Car </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="n">carrier_freq</span><span class="p">,</span> <span class="n">ch_omni</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parking</span><span class="p">)</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parking</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">end</span><span class="o">==</span><span class="n">start</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="n">this_vehicle</span><span class="o">.</span><span class="n">set_route</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">speed_low</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">speed_high</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
                    <span class="k">break</span> <span class="c1"># route successful established, break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_vehicle</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># this will be called repeatedly</span>
    <span class="k">def</span> <span class="nf">on_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">):</span> 

        <span class="c1">## distribute the following events</span>
        <span class="k">if</span> <span class="n">event_obj</span><span class="o">==</span><span class="n">Event</span><span class="o">.</span><span class="n">MOBILITY_END</span><span class="p">:</span> <span class="c1"># a mobile node has finished its mobility?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_restart_node</span><span class="p">(</span><span class="n">sim_time</span><span class="p">,</span><span class="n">event_obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event_obj</span><span class="o">==</span><span class="n">Event</span><span class="o">.</span><span class="n">SIM_MOBILITY</span><span class="p">:</span> <span class="c1"># mobility progresses a time step?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_mobility</span><span class="p">(</span><span class="n">sim_time</span><span class="p">,</span><span class="n">event_obj</span><span class="p">)</span>

    <span class="c1">## end of mobility, then find another parking location to move to</span>
    <span class="k">def</span> <span class="nf">do_restart_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">):</span>
        <span class="n">this_node</span> <span class="o">=</span> <span class="n">event_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">)</span> <span class="c1"># get the node reaching end of mobility</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">this_node</span><span class="o">.</span><span class="n">end_pin</span>    <span class="c1"># this will be the start location</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parking</span><span class="p">)</span>  <span class="c1"># end location is a random choice</span>
            <span class="k">if</span> <span class="n">end</span><span class="o">==</span><span class="n">start</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">this_node</span><span class="o">.</span><span class="n">set_route</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">speed_low</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">speed_high</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
                <span class="k">break</span> <span class="c1"># route successful established, break</span>

    <span class="c1">## Do user simulation here</span>
    <span class="k">def</span> <span class="nf">do_mobility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">):</span>

        <span class="c1">## iterate all BSs to check its vehicle connectivity</span>
        <span class="k">for</span> <span class="n">bs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_bs_nodes</span><span class="p">:</span>

            <span class="n">vehicle</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">serving_node</span>
            <span class="k">if</span> <span class="n">vehicle</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if none</span>

            <span class="n">beacon</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">bs</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">unicast</span><span class="p">(</span><span class="n">beacon</span><span class="p">,</span><span class="n">vehicle</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># lost connection</span>
                <span class="n">bs</span><span class="o">.</span><span class="n">lost_vehicle</span><span class="p">(</span><span class="n">sim_time</span><span class="p">)</span>

        <span class="c1">## main task: make associatiation with a vehicle if available</span>
        <span class="k">for</span> <span class="n">bs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_bs_nodes</span><span class="p">:</span>

            <span class="c1">## step 1: check service status, skip if already serving a vehicle</span>
            <span class="k">if</span> <span class="n">bs</span><span class="o">.</span><span class="n">serving_node</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>

            <span class="c1">## step 2: find strongest SNR to associate</span>
            <span class="n">vehicle_max</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">detection_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">beacon</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
            <span class="n">vehicle_list</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">beacon</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">vehicle</span><span class="p">,</span><span class="n">signal</span><span class="p">)</span> <span class="ow">in</span> <span class="n">vehicle_list</span><span class="p">:</span>
                <span class="c1">## 2.1 check that the reachable node is a vehicle without service</span>
                <span class="k">if</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">type</span><span class="o">!=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">Vehicle</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if not Vehicle</span>
                <span class="k">if</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">associated_bs</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if already being served</span>

                <span class="c1">## 2.2 vehicle sends beacon reply for bs to measure signal quality</span>
                <span class="n">beacon_reply</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
                <span class="n">recv_signal</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">unicast</span><span class="p">(</span><span class="n">beacon_reply</span><span class="p">,</span><span class="n">bs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">recv_signal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip if failed, likely not in coverage</span>

                <span class="c1">## 2.3 append to the detection list</span>
                <span class="n">detection_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">vehicle</span><span class="p">,</span><span class="n">recv_signal</span><span class="o">.</span><span class="n">quality</span><span class="p">))</span>

            <span class="c1">## step 3: associate with the vehicle with the strongest SNR, if exists</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">detection_list</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">vehicle_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">detection_list</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">vehicle_max</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
                <span class="n">bs</span><span class="o">.</span><span class="n">connect_vehicle</span><span class="p">(</span><span class="n">vehicle_max</span><span class="p">,</span><span class="n">sim_time</span><span class="p">)</span>

        <span class="c1">## draw connectivity &amp; bs coverage on the map</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_vehicles</span><span class="p">:</span>
            <span class="n">vehicle</span><span class="o">.</span><span class="n">show_connection</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">bs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_bs_nodes</span><span class="p">:</span>
            <span class="n">bs</span><span class="o">.</span><span class="n">show_coverage</span><span class="p">()</span>

<span class="c1">####################################################################</span>
<span class="c1">## The Main</span>
<span class="c1">####################################################################</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1">## create, setup and run the simulation</span>
    <span class="c1">## note that to run a simulation, we need to create a &#39;scenario&#39;</span>
    <span class="n">run_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">run_flag</span><span class="p">:</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">World</span><span class="p">()</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">sim_stop</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> 
                <span class="n">sim_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
                <span class="n">sim_speed</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> 
                <span class="n">display_option</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                <span class="n">scenario</span><span class="o">=</span><span class="n">MyScenario</span><span class="p">(</span><span class="n">sim</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running PyMoSim version v</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">sim</span><span class="o">.</span><span class="n">version</span><span class="p">())</span>
        <span class="n">run_flag</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        
</pre></div>
</div>
</details></div>
<div class="section" id="module-example7">
<span id="example-7"></span><h2>Example 7<a class="headerlink" href="#module-example7" title="Permalink to this headline">¶</a></h2>
<p>This is an example demonstrating a traffic light control. The example introduces
three features:</p>
<ul class="simple">
<li><p>How to create a timer. The timer is used to control the traffic lights.</p></li>
<li><p>How to displace a text on the map.</p></li>
<li><p>How to use <a class="reference internal" href="node.mobility2.html#node.mobility2.RoutePath" title="node.mobility2.RoutePath"><code class="xref py py-class docutils literal notranslate"><span class="pre">node.mobility2.RoutePath</span></code></a> to create mobility. In this mobility model, 
vehicles are aware of others and must follow the vehicles in front. The mobility 
implementation uses a specic car following model to achieve realistic mobility.</p></li>
</ul>
<p>We place two traffic lights at two junctions and create some volume of traffic
around the junctions.</p>
<img alt="_images/example7.gif" src="_images/example7.gif" />
<details class="summary-show-source-code">
<summary>Show source code</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This is an example demonstrating a traffic light control. The example introduces</span>
<span class="sd">three features:</span>

<span class="sd">- How to create a timer. The timer is used to control the traffic lights.</span>
<span class="sd">- How to displace a text on the map.</span>
<span class="sd">- How to use :class:`node.mobility2.RoutePath` to create mobility. In this mobility model, </span>
<span class="sd">  vehicles are aware of others and must follow the vehicles in front. The mobility </span>
<span class="sd">  implementation uses a specic car following model to achieve realistic mobility.</span>

<span class="sd">We place two traffic lights at two junctions and create some volume of traffic</span>
<span class="sd">around the junctions.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">wx</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">sim.simulation</span> <span class="kn">import</span> <span class="n">World</span>
<span class="kn">from</span> <span class="nn">sim.loc</span> <span class="kn">import</span> <span class="n">ScreenXY</span> <span class="k">as</span> <span class="n">XY</span>
<span class="kn">from</span> <span class="nn">sim.direction</span> <span class="kn">import</span> <span class="n">Dir2D</span>
<span class="kn">from</span> <span class="nn">sim.scenario</span> <span class="kn">import</span> <span class="n">BaseScenario</span>
<span class="kn">from</span> <span class="nn">sim.event</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">sim.drawable</span> <span class="kn">import</span> <span class="n">Drawable</span><span class="p">,</span> <span class="n">Draw</span>
<span class="kn">from</span> <span class="nn">node.node</span> <span class="kn">import</span> <span class="n">BaseNode</span>
<span class="kn">from</span> <span class="nn">node.mobility</span> <span class="kn">import</span> <span class="n">Stationary</span>
<span class="kn">from</span> <span class="nn">node.mobility2</span> <span class="kn">import</span> <span class="n">RouteHandler</span><span class="p">,</span> <span class="n">RoutePath</span>
<span class="kn">from</span> <span class="nn">node.timer</span> <span class="kn">import</span> <span class="n">NodeTimer</span>
<span class="kn">from</span> <span class="nn">map.mapinfo</span> <span class="kn">import</span> <span class="n">MapInfo</span>
<span class="kn">import</span> <span class="nn">node.type</span> <span class="k">as</span> <span class="nn">NodeType</span>
<span class="kn">import</span> <span class="nn">map.pin</span> <span class="k">as</span> <span class="nn">Pin</span>


<span class="c1">####################################################################</span>
<span class="c1">## Traffic Light &amp; Vehicle</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">MyTrafficLight</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span> 
    <span class="sd">&#39;&#39;&#39;MyTrafficLight: This is a traffic light design.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">Hidden</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">Stationary</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">two_sides</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Dir2D</span><span class="p">(</span><span class="n">angle</span><span class="p">):</span><span class="mi">1</span><span class="p">,</span> <span class="n">Dir2D</span><span class="p">(</span><span class="n">angle</span><span class="o">+</span><span class="mi">180</span><span class="p">):</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">Dir2D</span><span class="p">(</span><span class="n">angle</span><span class="o">+</span><span class="mi">90</span><span class="p">):</span><span class="mi">2</span><span class="p">,</span> <span class="n">Dir2D</span><span class="p">(</span><span class="n">angle</span><span class="o">+</span><span class="mi">270</span><span class="p">):</span><span class="mi">2</span> <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicator1</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span> <span class="p">}</span> <span class="c1"># one side green, another side red</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicator2</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span> <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_indicator</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicator1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">NodeTimer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redraw_indicator</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_indicator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">car_direction</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction&quot;</span><span class="p">)</span> <span class="c1"># the traffic light needs to find out</span>
        <span class="k">for</span> <span class="nb">dir</span><span class="p">,</span><span class="n">side</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_sides</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1">#        which side the car is facing</span>
            <span class="k">if</span> <span class="n">car_direction</span><span class="o">.</span><span class="n">is_within</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="mi">45</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_indicator</span><span class="p">[</span><span class="n">side</span><span class="p">]</span> <span class="c1"># found the side, return indicator</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something is wrong&quot;</span><span class="p">)</span> <span class="c1"># shouldn&#39;t reach this line</span>
        <span class="k">return</span> <span class="s2">&quot;red&quot;</span>

    <span class="k">def</span> <span class="nf">switch_indicator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_indicator</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicator1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_indicator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicator2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_indicator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicator1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redraw_indicator</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">redraw_indicator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_drawing</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">this_dir</span><span class="p">,</span><span class="n">this_side</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_sides</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="c1"># draw a sector for each side</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_indicator</span><span class="p">[</span><span class="n">this_side</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;green&quot;</span><span class="p">:</span>
                <span class="n">pen</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">GREEN_PEN</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pen</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">RED_PEN</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_sector</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="n">this_dir</span><span class="o">.</span><span class="n">get_azimuth</span><span class="p">(),</span><span class="mi">60</span><span class="p">,</span><span class="n">pen</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyVehicle</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;MyVehicle: This is a vehicle design.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="nb">map</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">Vehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="nb">map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visible_range</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">num_pixels</span><span class="p">(</span><span class="n">len_in_meter</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">start_pin</span><span class="p">,</span> <span class="n">end_pin</span><span class="p">,</span> <span class="n">speed_low</span><span class="p">,</span> <span class="n">speed_high</span><span class="p">,</span> <span class="n">delay_start</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">route</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span><span class="n">start_pin</span><span class="p">,</span><span class="n">end_pin</span><span class="p">,</span><span class="n">delay_start</span><span class="p">)</span>
        <span class="n">road_segment_list</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">get_road_segment_list</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">road_segment_list</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>

        <span class="c1">## set a random speed to each road segment in the route</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">road_segment_list</span><span class="p">)):</span>
            <span class="n">speed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">speed_low</span><span class="p">,</span><span class="n">speed_high</span><span class="p">)</span>   <span class="c1"># in km/h</span>
            <span class="n">speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">kph</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="n">speed_up_factor</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># in pixels/sec</span>
            <span class="n">route</span><span class="o">.</span><span class="n">assign_speed</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">speed</span><span class="p">)</span>

        <span class="c1">## assign the mobility to this node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">can_see_traffic_light</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">distance_to</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">visible_range</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span> <span class="c1"># outside of range, can&#39;t see</span>

        <span class="n">angle_to_the_loc</span> <span class="o">=</span> <span class="n">Dir2D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">azimuth_to</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>
        <span class="n">current_moving_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;direction&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">current_moving_angle</span><span class="o">.</span><span class="n">is_within</span><span class="p">(</span><span class="n">angle_to_the_loc</span><span class="p">,</span><span class="mi">45</span><span class="p">):</span> <span class="c1"># +/- 45 degree</span>
            <span class="k">return</span> <span class="kc">False</span> <span class="c1"># not moving towards the location, can&#39;t see</span>

        <span class="k">return</span> <span class="kc">True</span> <span class="c1"># yes, within driver&#39;s vision</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mobility&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">go</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mobility&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>


<span class="c1">####################################################################</span>
<span class="c1">## Scenario setup</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">MyScenario</span><span class="p">(</span><span class="n">BaseScenario</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This is MyScenario. It reimplements on_create() and on_event().&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">on_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> <span class="c1"># this will be called at the start</span>

        <span class="c1">## load the map image and info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">MapInfo</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">image_file</span><span class="o">=</span><span class="s2">&quot;British-Museum.png&quot;</span><span class="p">,</span>
                           <span class="n">data_file</span><span class="o">=</span><span class="s2">&quot;British-Museum.json&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">is_ready</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to load the map. The reason is: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">get_err_str</span><span class="p">())</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1">## use the map and give a name to this scenario</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;Traffic Light Demo&quot;</span><span class="p">)</span>

        <span class="c1">## load the landmark pin, show it on the map with a fancy font</span>
        <span class="c1">## we shall use `pin` module to access to the pin properties</span>
        <span class="n">my_landmark</span> <span class="o">=</span> <span class="n">Pin</span><span class="o">.</span><span class="n">Landmark</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">pin_name</span><span class="o">=</span><span class="s2">&quot;BritishMuseum&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">my_landmark</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">my_landmark</span><span class="o">.</span><span class="n">get_xy</span><span class="p">()</span>
            <span class="n">pin_text</span> <span class="o">=</span> <span class="n">my_landmark</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;British Museum&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_drawable</span><span class="p">(</span><span class="n">Drawable</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">pin_text</span><span class="p">,</span><span class="n">position</span><span class="o">=</span><span class="n">Draw</span><span class="o">.</span><span class="n">XYCENTER</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">set_font</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">FONTFAMILY_ROMAN</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">FONTSTYLE_NORMAL</span><span class="p">,</span> 
                                          <span class="n">wx</span><span class="o">.</span><span class="n">FONTWEIGHT_NORMAL</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: can&#39;t load landmark pin: &#39;BritishMuseum&#39;.&quot;</span><span class="p">)</span>

        <span class="c1">## load all other pins, since we only need their (x,y) location, we can access </span>
        <span class="c1">## directly by using the `MapInfo` instance</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;North&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;NorthWest&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;West&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;South&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;NorthEast&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;East&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;TrafficLightNorth&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;TrafficLightSouth&quot;</span><span class="p">:</span> <span class="kc">None</span> <span class="p">}</span>
        <span class="k">for</span> <span class="n">pin_name</span> <span class="ow">in</span> <span class="n">loc</span><span class="p">:</span>
            <span class="n">loc</span><span class="p">[</span><span class="n">pin_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">get_pin_xy</span><span class="p">(</span><span class="n">pin_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loc</span><span class="p">[</span><span class="n">pin_name</span><span class="p">]</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to load this pin: `</span><span class="si">%s</span><span class="s2">`.&quot;</span><span class="o">%</span><span class="n">pin_name</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1">## create traffic lights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traffic_lights</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">loc</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;TrafficLight&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span> <span class="k">continue</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">this_light</span> <span class="o">=</span> <span class="n">MyTrafficLight</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">XY</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="n">angle</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traffic_lights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_light</span><span class="p">)</span>

        <span class="c1">## create the route handler to manage mobility</span>
        <span class="c1">## this is needed for `RoutePath` mobility</span>
        <span class="n">route_handler</span> <span class="o">=</span> <span class="n">RouteHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">route_handler</span><span class="o">.</span><span class="n">is_ready</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to create a route handler.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1">## create some vehicles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_vehicles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_design</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_design</span><span class="p">[</span><span class="s2">&quot;n-s&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;North&quot;</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;South&quot;</span> <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_design</span><span class="p">[</span><span class="s2">&quot;s-n&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;South&quot;</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;North&quot;</span> <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_design</span><span class="p">[</span><span class="s2">&quot;e-w&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;East&quot;</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;West&quot;</span> <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_design</span><span class="p">[</span><span class="s2">&quot;w-e&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;West&quot;</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;East&quot;</span> <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_design</span><span class="p">[</span><span class="s2">&quot;nw-ne&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;NorthWest&quot;</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;NorthEast&quot;</span> <span class="p">}</span>
        <span class="k">for</span> <span class="n">path_name</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_design</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">start_pin</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">]</span>
            <span class="n">end_pin</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">15</span><span class="p">)):</span>
                <span class="n">this_vehicle</span> <span class="o">=</span> <span class="n">MyVehicle</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="s2">&quot;Car (</span><span class="si">%s</span><span class="s2">)-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">path_name</span><span class="p">,</span><span class="n">idx</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">this_vehicle</span><span class="o">.</span><span class="n">set_route</span><span class="p">(</span><span class="n">route_handler</span><span class="p">,</span> <span class="n">start_pin</span><span class="p">,</span> <span class="n">end_pin</span><span class="p">,</span>
                                              <span class="n">speed_low</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">speed_high</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                                              <span class="n">delay_start</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to find a path from `</span><span class="si">%s</span><span class="s2">` to `</span><span class="si">%s</span><span class="s2">`.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">start_pin</span><span class="p">,</span><span class="n">end_pin</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hint: check for path existence, also pay attention to one-way streets.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_vehicle</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1">## this will be called repeatedly</span>
    <span class="k">def</span> <span class="nf">on_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">):</span> 

        <span class="c1">## distribute the following events</span>
        <span class="k">if</span> <span class="n">event_obj</span><span class="o">==</span><span class="n">Event</span><span class="o">.</span><span class="n">MOBILITY_END</span><span class="p">:</span> <span class="c1"># a mobile node has finished its mobility?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_restart_node</span><span class="p">(</span><span class="n">sim_time</span><span class="p">,</span><span class="n">event_obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event_obj</span><span class="o">==</span><span class="n">Event</span><span class="o">.</span><span class="n">SIM_MOBILITY</span><span class="p">:</span> <span class="c1"># mobility progresses a time step?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_mobility</span><span class="p">(</span><span class="n">sim_time</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event_obj</span><span class="o">==</span><span class="n">Event</span><span class="o">.</span><span class="n">TIMER_EXPIRED</span><span class="p">:</span> <span class="c1"># a timer expired?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_timer</span><span class="p">(</span><span class="n">sim_time</span><span class="p">,</span><span class="n">event_obj</span><span class="p">)</span>

    <span class="c1">## end of mobility, then repeat the mobility again with a random delay start</span>
    <span class="k">def</span> <span class="nf">do_restart_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">):</span>
        <span class="n">this_node</span> <span class="o">=</span> <span class="n">event_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">)</span> <span class="c1"># get the node reaching end of mobility</span>
        <span class="n">this_node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mobility&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">restart</span><span class="p">(</span><span class="n">delay_start</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

    <span class="c1">## a timer set by the traffic light has expired, switch light indicator</span>
    <span class="k">def</span> <span class="nf">do_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">):</span>
        <span class="n">this_traffic_light</span> <span class="o">=</span> <span class="n">event_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">)</span> <span class="c1"># get the node that started the timer</span>
        <span class="n">this_traffic_light</span><span class="o">.</span><span class="n">switch_indicator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_mobility</span><span class="p">(</span><span class="n">sim_time</span><span class="p">)</span> <span class="c1"># signal has changed, all vehicles should react</span>

    <span class="c1">## Do user simulation here</span>
    <span class="k">def</span> <span class="nf">do_mobility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_vehicles</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">light</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traffic_lights</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">can_see_traffic_light</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">light</span><span class="o">.</span><span class="n">get_indicator</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;red&quot;</span><span class="p">:</span>
                        <span class="n">vehicle</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vehicle</span><span class="o">.</span><span class="n">go</span><span class="p">()</span> <span class="c1"># continue driving for any non &quot;red&quot; return</span>

<span class="c1">####################################################################</span>
<span class="c1">## The Main</span>
<span class="c1">####################################################################</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">run_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">run_flag</span><span class="p">:</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">World</span><span class="p">()</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">sim_stop</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> 
                <span class="n">sim_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
                <span class="n">sim_speed</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> 
                <span class="n">display_option</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                <span class="n">scenario</span><span class="o">=</span><span class="n">MyScenario</span><span class="p">(</span><span class="n">sim</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running PyMoSim version v</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">sim</span><span class="o">.</span><span class="n">version</span><span class="p">())</span>
        <span class="n">run_flag</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</details></div>
<div class="section" id="module-example8">
<span id="example-8"></span><h2>Example 8<a class="headerlink" href="#module-example8" title="Permalink to this headline">¶</a></h2>
<p>This example demonstrates how to implement reconfigurable intelligent 
surface (RIS) using <a class="reference internal" href="comm.transceiver.html#comm.transceiver.UserTransceiver" title="comm.transceiver.UserTransceiver"><code class="xref py py-class docutils literal notranslate"><span class="pre">comm.transceiver.UserTransceiver</span></code></a>. It also 
uses <a class="reference internal" href="comm.signalwave.html#comm.signalwave.QualityBasedSignal" title="comm.signalwave.QualityBasedSignal"><code class="xref py py-class docutils literal notranslate"><span class="pre">comm.signalwave.QualityBasedSignal</span></code></a> for transmission. It 
illustrates how users can implement multipath signal propagation and 
detection logic. The example is an extension of example5.py which shows 
how to use <a class="reference internal" href="comm.transceiver.html#comm.transceiver.UserTransceiver" title="comm.transceiver.UserTransceiver"><code class="xref py py-class docutils literal notranslate"><span class="pre">comm.transceiver.UserTransceiver</span></code></a>. It is important
to understand example5.py first.</p>
<p>The scenario replicates the experiment of single RIS case presented in <a class="reference internal" href="example8.html#r89e13abb20a9-wfy20" id="id2">[WFY20]</a>.
See also Fig. 2 in the paper for the experiment setup and Fig. 3 for the
experiment results.</p>
<div class="section" id="id3">
<h3>References<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<dl class="citation">
<dt class="label" id="r89e13abb20a9-wfy20"><span class="brackets"><a class="fn-backref" href="#id2">WFY20</a></span></dt>
<dd><p>P. Wang, J. Fang, X. Yuan, Z. Chen, and H. Li, “Intelligent 
reflecting surface-assisted millimeter wave communications: Joint 
active and passive precoding design,” IEEE Transactions on Vehicular 
Technology, vol. 69, no. 12, pp. 14960-14973, 2020. 
(link: <a class="reference external" href="https://arxiv.org/pdf/1908.10734.pdf">https://arxiv.org/pdf/1908.10734.pdf</a>)</p>
</dd>
</dl>
</div>
<img alt="_images/example8.gif" src="_images/example8.gif" />
<div class="section" id="result-comparison">
<h3>Result Comparison<a class="headerlink" href="#result-comparison" title="Permalink to this headline">¶</a></h3>
<img alt="_images/example8-comparison.png" src="_images/example8-comparison.png" />
<p>From the paper (left) versus from our simulation (right).</p>
<details class="summary-show-source-code">
<summary>Show source code</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This example demonstrates how to implement reconfigurable intelligent </span>
<span class="sd">surface (RIS) using :class:`comm.transceiver.UserTransceiver`. It also </span>
<span class="sd">uses :class:`comm.signalwave.QualityBasedSignal` for transmission. It </span>
<span class="sd">illustrates how users can implement multipath signal propagation and </span>
<span class="sd">detection logic. The example is an extension of example5.py which shows </span>
<span class="sd">how to use :class:`comm.transceiver.UserTransceiver`. It is important</span>
<span class="sd">to understand example5.py first.</span>

<span class="sd">The scenario replicates the experiment of single RIS case presented in [WFY20]_.</span>
<span class="sd">See also Fig. 2 in the paper for the experiment setup and Fig. 3 for the</span>
<span class="sd">experiment results.</span>

<span class="sd">References</span>
<span class="sd">----------</span>
<span class="sd">.. [WFY20] P. Wang, J. Fang, X. Yuan, Z. Chen, and H. Li, &quot;Intelligent </span>
<span class="sd">    reflecting surface-assisted millimeter wave communications: Joint </span>
<span class="sd">    active and passive precoding design,&quot; IEEE Transactions on Vehicular </span>
<span class="sd">    Technology, vol. 69, no. 12, pp. 14960-14973, 2020. </span>
<span class="sd">    (link: https://arxiv.org/pdf/1908.10734.pdf)</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">wx</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span><span class="p">,</span> <span class="n">ArgumentParser</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="c1">## import the following packages for plotting</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1">## PyMoSim packages</span>
<span class="kn">from</span> <span class="nn">sim.simulation</span> <span class="kn">import</span> <span class="n">World</span>
<span class="kn">from</span> <span class="nn">sim.loc</span> <span class="kn">import</span> <span class="n">ScreenXY</span> <span class="k">as</span> <span class="n">XY</span>
<span class="kn">from</span> <span class="nn">sim.direction</span> <span class="kn">import</span> <span class="n">Dir2D</span>
<span class="kn">from</span> <span class="nn">sim.scenario</span> <span class="kn">import</span> <span class="n">BaseScenario</span>
<span class="kn">from</span> <span class="nn">sim.drawable</span> <span class="kn">import</span> <span class="n">Drawable</span>
<span class="kn">from</span> <span class="nn">sim.event</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">node.node</span> <span class="kn">import</span> <span class="n">BaseNode</span>
<span class="kn">from</span> <span class="nn">node.mobility</span> <span class="kn">import</span> <span class="n">Stationary</span><span class="p">,</span> <span class="n">StaticPath</span>
<span class="kn">from</span> <span class="nn">comm.transceiver</span> <span class="kn">import</span> <span class="n">UserTransceiver</span>
<span class="kn">from</span> <span class="nn">node.obstacle</span> <span class="kn">import</span> <span class="n">Obstacle</span>
<span class="kn">import</span> <span class="nn">node.type</span> <span class="k">as</span> <span class="nn">NodeType</span>

<span class="c1">####################################################################</span>
<span class="c1">## define coordination translation to match the example in [r1]</span>
<span class="c1">####################################################################</span>

<span class="k">def</span> <span class="nf">resolution</span><span class="p">():</span> <span class="c1"># pixel-to-meter ratio</span>
    <span class="k">return</span> <span class="mi">2</span>

<span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="n">x_val</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">resolution</span><span class="p">()</span><span class="o">*</span><span class="n">x_val</span> <span class="o">+</span> <span class="mi">30</span>

<span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="n">y_val</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">150</span> <span class="o">-</span> <span class="n">resolution</span><span class="p">()</span><span class="o">*</span><span class="n">y_val</span>

<span class="c1">####################################################################</span>
<span class="c1">## collect statistics</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">Result</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>     <span class="c1"># x is the distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ris</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># with RIS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nris</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># without RIS</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">Result</span><span class="p">()</span> <span class="c1"># the instance</span>

<span class="c1">####################################################################</span>
<span class="c1">## My Transceiver</span>
<span class="c1">## - Perform own signal propagation and detection logic</span>
<span class="c1">## - Aware of an obstacle</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">MyTransceiver</span><span class="p">(</span><span class="n">UserTransceiver</span><span class="p">):</span>

    <span class="c1">## class constants</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="o">-</span><span class="mi">90</span> <span class="c1"># dBm</span>
    <span class="n">snr_threshold</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># dB</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">azimuth_angle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beam_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">28</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Initialize and customize a transceiver.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        azimuth_angle : float, optional, default=None</span>
<span class="sd">            If it is not None, it specifies the transceiver facing angle.</span>
<span class="sd">        beam_width : float, optional, default=None</span>
<span class="sd">            If `azimuth_angle` is not None, it specifies supported angle width.</span>
<span class="sd">            The supported angle is within the range</span>
<span class="sd">            [azimuth_angle-0.5*beam_width,azimuth_angle+0.5*beam_width].</span>
<span class="sd">        freq : float, optional, default=28</span>
<span class="sd">            The carrier frequency. Default is 28 (or 28 GHz mmWave).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="n">freq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azimuth</span> <span class="o">=</span> <span class="n">Dir2D</span><span class="p">(</span><span class="n">azimuth_angle</span><span class="p">)</span> <span class="k">if</span> <span class="n">azimuth_angle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beam_width</span> <span class="o">=</span> <span class="n">beam_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obstacle_list</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">create_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_power</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Use this method to create a signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tx_power : float</span>
<span class="sd">            The transmit power of the signal.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`comm.signalwave.QualityBasedSignal`</span>
<span class="sd">            The created signal to be used for transmission.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">tx_power</span> <span class="o">=</span> <span class="n">tx_power</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">add_info</span><span class="p">(</span><span class="s2">&quot;ant element&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># number of antenna elements</span>
        <span class="k">return</span> <span class="n">signal</span>

    <span class="k">def</span> <span class="nf">create_multipath_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_power</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Use this method to create a signal that is part of a multipath </span>
<span class="sd">        signal. A multipath signal is a signal that consists of many paths</span>
<span class="sd">        of transmissions. It is meaningless to decode this signal alone, rather</span>
<span class="sd">        all parts of the multipath signal should be consolidated first before</span>
<span class="sd">        judging whether the multipath signal is detectable. To decode all parts,</span>
<span class="sd">        use `create_final_multipath_signal()` with passing all other parts of the</span>
<span class="sd">        signal when calling.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tx_power : float</span>
<span class="sd">            The transmit power of the signal.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`comm.signalwave.QualityBasedSignal`</span>
<span class="sd">            The created signal to be used for transmission.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">MyTransceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tx_power</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">add_info</span><span class="p">(</span><span class="s2">&quot;multipath&quot;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># one part of a multipath signal</span>
        <span class="k">return</span> <span class="n">signal</span>

    <span class="k">def</span> <span class="nf">create_final_multipath_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_power</span><span class="p">,</span> <span class="n">signal_list</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Use this method to create a final multipath signal. The receiver</span>
<span class="sd">        will finally consolidate all parts of the multipath signal and judge </span>
<span class="sd">        whether the consolidated signal is detectable.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        signal_list : List of :class:`comm.signalwave.QualityBasedSignal`</span>
<span class="sd">            The list of all other received parts of the multipath signal to be</span>
<span class="sd">            consolidated for detection.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">MyTransceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tx_power</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">add_info</span><span class="p">(</span><span class="s2">&quot;multipath signals&quot;</span><span class="p">,</span><span class="n">signal_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">signal</span>

    <span class="k">def</span> <span class="nf">set_obstacle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obstacle_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obstacle_list</span> <span class="o">=</span> <span class="n">obstacle_list</span>

    <span class="k">def</span> <span class="nf">is_crossed_obstacle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_loc</span><span class="p">,</span> <span class="n">rx_loc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obstacle_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="n">point1</span> <span class="o">=</span> <span class="n">tx_loc</span><span class="o">.</span><span class="n">get_xy</span><span class="p">()</span>
        <span class="n">point2</span> <span class="o">=</span> <span class="n">rx_loc</span><span class="o">.</span><span class="n">get_xy</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">obstacle_list</span><span class="o">.</span><span class="n">is_crossed</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span><span class="n">point2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">can_detect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">the_signal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;This is the function to perform signal propagation and</span>
<span class="sd">        detection logic.&#39;&#39;&#39;</span>

        <span class="c1">## retrieve all key info first</span>
        <span class="n">tx_power</span> <span class="o">=</span> <span class="n">the_signal</span><span class="o">.</span><span class="n">tx_power</span>      <span class="c1"># get the tx power in dBm</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">the_signal</span><span class="o">.</span><span class="n">distance</span>      <span class="c1"># get the distance travelled</span>
        <span class="n">travelling_dir</span> <span class="o">=</span> <span class="n">the_signal</span><span class="o">.</span><span class="n">LOS_dir</span> <span class="c1"># get the travelling direction</span>
        <span class="n">tx_loc</span> <span class="o">=</span> <span class="n">the_signal</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">)</span> <span class="c1"># sender location</span>
        <span class="n">rx_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">)</span>              <span class="c1"># receiver location</span>
        <span class="n">tx_trx</span> <span class="o">=</span> <span class="n">the_signal</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">_node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;transceiver&quot;</span><span class="p">)</span> <span class="c1"># sender transceiver</span>
        <span class="n">rx_trx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;transceiver&quot;</span><span class="p">)</span>              <span class="c1"># receiver transceiver</span>

        <span class="c1">## check if both sender and receiver support the angle</span>
        <span class="k">if</span> <span class="n">tx_trx</span><span class="o">.</span><span class="n">azimuth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tx_dir</span> <span class="o">=</span> <span class="n">Dir2D</span><span class="p">(</span><span class="n">travelling_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tx_trx</span><span class="o">.</span><span class="n">azimuth</span><span class="o">.</span><span class="n">is_within</span><span class="p">(</span><span class="n">tx_dir</span><span class="p">,</span><span class="n">tx_trx</span><span class="o">.</span><span class="n">beam_width</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span> <span class="c1"># outside of sender&#39;s transmission angle coverage</span>
        <span class="k">if</span> <span class="n">rx_trx</span><span class="o">.</span><span class="n">azimuth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rx_dir</span> <span class="o">=</span> <span class="n">Dir2D</span><span class="p">(</span><span class="n">travelling_dir</span><span class="o">+</span><span class="mi">180</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rx_trx</span><span class="o">.</span><span class="n">azimuth</span><span class="o">.</span><span class="n">is_within</span><span class="p">(</span><span class="n">rx_dir</span><span class="p">,</span><span class="n">rx_trx</span><span class="o">.</span><span class="n">beam_width</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span> <span class="c1"># outside of receiver&#39;s detection angle coverage</span>

        <span class="c1">## check if signal is crossing obstacle</span>
        <span class="n">is_crossed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_crossed_obstacle</span><span class="p">(</span><span class="n">tx_loc</span><span class="p">,</span><span class="n">rx_loc</span><span class="p">)</span>

        <span class="c1">## apply simple passloss model c0*d^(-α), where</span>
        <span class="c1">#  - d is the distance, in our system, 2 pixels = 1m, minimum 1m</span>
        <span class="c1">#  - α is the pathloss exponent, 2 for normal, 2.92 when crossing an obstacle</span>
        <span class="c1">#  - c0 is the gain/loss</span>
        <span class="c1">## pathloss PL_db = log10(c0) + 10α*log10(d)</span>
        <span class="n">distance</span> <span class="o">/=</span> <span class="n">resolution</span><span class="p">()</span>  <span class="c1"># convert pixel-to-meter</span>
        <span class="k">if</span> <span class="n">distance</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">distance</span><span class="o">=</span><span class="mi">1</span> <span class="c1"># min 1m</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_crossed</span> <span class="k">else</span> <span class="mf">2.92</span>   <span class="c1"># set pathloss exponent</span>
        <span class="n">log_c0</span> <span class="o">=</span> <span class="mf">61.4</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_crossed</span> <span class="k">else</span> <span class="mi">72</span> <span class="c1"># set loss</span>
        <span class="n">pathloss_db</span> <span class="o">=</span> <span class="n">log_c0</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>

        <span class="c1">## received power including the gain from the number of antenna elements</span>
        <span class="n">ant_element_num</span> <span class="o">=</span> <span class="n">the_signal</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="s2">&quot;ant element&quot;</span><span class="p">)</span>
        <span class="n">received_power</span> <span class="o">=</span> <span class="n">tx_power</span> <span class="o">-</span> <span class="n">pathloss_db</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ant_element_num</span><span class="p">)</span>

        <span class="c1">## check if the signal is one part of a multipath signal</span>
        <span class="c1">## if so, return True for detectability</span>
        <span class="k">if</span> <span class="n">the_signal</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="s2">&quot;multipath&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">the_signal</span><span class="o">.</span><span class="n">quality</span> <span class="o">=</span> <span class="n">received_power</span>
            <span class="n">the_signal</span><span class="o">.</span><span class="n">add_info</span><span class="p">(</span><span class="s2">&quot;crossed_obstacle&quot;</span><span class="p">,</span><span class="n">is_crossed</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span> <span class="c1"># can detect as one of the multipath signals</span>

        <span class="c1">## check if the signal is the final part of a multipath signal</span>
        <span class="c1">## if so, consolidate all received powers</span>
        <span class="n">multipath_signal_list</span> <span class="o">=</span> <span class="n">the_signal</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="s2">&quot;multipath signals&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">multipath_signal_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">received_power_mW</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">received_power</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># from this signal</span>
            <span class="k">for</span> <span class="n">each_signal</span> <span class="ow">in</span> <span class="n">multipath_signal_list</span><span class="p">:</span>
                <span class="n">received_power_mW</span> <span class="o">+=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">each_signal</span><span class="o">.</span><span class="n">quality</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># each other part</span>
            <span class="n">received_power</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">received_power_mW</span><span class="p">)</span>

        <span class="c1">## check if the signal is detectable, i.e. its SNR</span>
        <span class="c1">## exceeds the threshold (default setting, see `MyTransceiver.snr_threshold`)</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="n">received_power</span><span class="o">-</span><span class="n">MyTransceiver</span><span class="o">.</span><span class="n">noise</span>
        <span class="k">if</span> <span class="n">snr</span><span class="o">&gt;=</span><span class="n">MyTransceiver</span><span class="o">.</span><span class="n">snr_threshold</span><span class="p">:</span> 
            <span class="n">the_signal</span><span class="o">.</span><span class="n">quality</span> <span class="o">=</span> <span class="n">received_power</span>
            <span class="n">the_signal</span><span class="o">.</span><span class="n">add_info</span><span class="p">(</span><span class="s2">&quot;crossed_obstacle&quot;</span><span class="p">,</span><span class="n">is_crossed</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span> <span class="c1"># can detect</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">the_signal</span><span class="o">.</span><span class="n">quality</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="kc">False</span> <span class="c1"># cannot detect</span>

<span class="k">class</span> <span class="nc">MyTransceiverBS</span><span class="p">(</span><span class="n">MyTransceiver</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx_power</span> <span class="o">=</span> <span class="mi">30</span> <span class="c1"># dBm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ant_element</span> <span class="o">=</span> <span class="mi">64</span>

    <span class="k">def</span> <span class="nf">create_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">the_signal</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tx_power</span><span class="p">)</span>
        <span class="n">the_signal</span><span class="o">.</span><span class="n">add_info</span><span class="p">(</span><span class="s2">&quot;ant element&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ant_element</span><span class="p">)</span> <span class="c1"># number of antenna elements</span>
        <span class="k">return</span> <span class="n">the_signal</span>

    <span class="k">def</span> <span class="nf">create_multipath_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">the_signal</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create_multipath_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tx_power</span><span class="p">)</span>
        <span class="n">the_signal</span><span class="o">.</span><span class="n">add_info</span><span class="p">(</span><span class="s2">&quot;ant element&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ant_element</span><span class="p">)</span> <span class="c1"># number of antenna elements</span>
        <span class="k">return</span> <span class="n">the_signal</span>

    <span class="k">def</span> <span class="nf">create_final_multipath_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_list</span><span class="p">):</span>
        <span class="n">the_signal</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create_final_multipath_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tx_power</span><span class="p">,</span> <span class="n">signal_list</span><span class="p">)</span>
        <span class="n">the_signal</span><span class="o">.</span><span class="n">add_info</span><span class="p">(</span><span class="s2">&quot;ant element&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ant_element</span><span class="p">)</span> <span class="c1"># number of antenna elements</span>
        <span class="k">return</span> <span class="n">the_signal</span>

<span class="k">class</span> <span class="nc">MyTransceiverRIS</span><span class="p">(</span><span class="n">MyTransceiver</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">azimuth_angle</span><span class="p">,</span> <span class="n">beam_width</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">azimuth_angle</span><span class="p">,</span> <span class="n">beam_width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ant_element</span> <span class="o">=</span> <span class="mi">200</span>

    <span class="k">def</span> <span class="nf">is_crossed_obstacle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_loc</span><span class="p">,</span> <span class="n">rx_loc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;Use this method to ignore obstacle between BS and RIS.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">create_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="c1"># Do not use. RIS can&#39;t create own signal, it can only relay signal</span>

    <span class="k">def</span> <span class="nf">create_multipath_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_power</span><span class="p">):</span>
        <span class="n">the_signal</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create_multipath_signal</span><span class="p">(</span><span class="n">tx_power</span><span class="p">)</span>
        <span class="n">the_signal</span><span class="o">.</span><span class="n">add_info</span><span class="p">(</span><span class="s2">&quot;ant element&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ant_element</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># RIS uses squared elements</span>
        <span class="k">return</span> <span class="n">the_signal</span>

    <span class="k">def</span> <span class="nf">create_final_multipath_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_list</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="c1"># Do not use. RIS should not create final signal</span>

<span class="k">class</span> <span class="nc">MyTransceiverVehicle</span><span class="p">(</span><span class="n">MyTransceiver</span><span class="p">):</span>
    <span class="k">pass</span> <span class="c1"># there is nothing needed to customize</span>

<span class="c1">####################################################################</span>
<span class="c1">## Nodes</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">MyBS</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MyBS: This is a base station in the VANET sim world implementing </span>
<span class="sd">    a user-defined transceiver.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">BaseStation</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">MyTransceiverBS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1">## setup the BS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_transceiver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">Stationary</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">MyVehicle</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MyVehicle: This is a transmitting node in the VANET sim world implementing </span>
<span class="sd">    a user-defined transceiver.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">Vehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="c1">## initialize some properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">MyTransceiverVehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_transceiver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">associated_bs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_ris</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_quality</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crossed_obstacle</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">## draw a line to the connected BS, if any</span>
    <span class="k">def</span> <span class="nf">show_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_drawing</span><span class="p">()</span>
        <span class="n">y_text_pos</span> <span class="o">=</span> <span class="mi">15</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_ris</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">30</span>
        <span class="n">y_text</span> <span class="o">=</span> <span class="s2">&quot;Without RIS&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_ris</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;With RIS&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_bs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">BLACK</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_text</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">y_text_pos</span><span class="p">,</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%1.2f</span><span class="s2">dB&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">y_text</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_quality</span><span class="o">-</span><span class="n">MyTransceiver</span><span class="o">.</span><span class="n">noise</span><span class="p">),</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">FONTFAMILY_ROMAN</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">FONTSTYLE_NORMAL</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">FONTWEIGHT_NORMAL</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_text</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">y_text_pos</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: No Signal&quot;</span><span class="o">%</span><span class="n">y_text</span><span class="p">,</span>
                            <span class="n">wx</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">FONTFAMILY_ROMAN</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">FONTSTYLE_NORMAL</span><span class="p">,</span> 
                                        <span class="n">wx</span><span class="o">.</span><span class="n">FONTWEIGHT_NORMAL</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">MyRIS</span><span class="p">(</span><span class="n">BaseNode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MyRIS: This is an reconfigurable intelligent surface (RIS).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">azimuth_angle</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="n">NodeType</span><span class="o">.</span><span class="n">RIS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">15</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">MyTransceiverRIS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">azimuth_angle</span><span class="p">,</span><span class="n">beam_width</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>

        <span class="c1">## setup the sector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_transceiver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transceiver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">Stationary</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="n">Dir2D</span><span class="p">(</span><span class="n">azimuth_angle</span><span class="p">)))</span>

<span class="c1">####################################################################</span>
<span class="c1">## Scenario</span>
<span class="c1">####################################################################</span>

<span class="k">class</span> <span class="nc">MyScenario</span><span class="p">(</span><span class="n">BaseScenario</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MyScenario: This is my scenario.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">##---------------------------------------------------------------</span>
    <span class="c1">## This method will be called before the start of the simulation,</span>
    <span class="c1">## build the simulation world here</span>
    <span class="k">def</span> <span class="nf">on_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simworld</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>

        <span class="c1">## give a name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;Demonstration of RIS&quot;</span><span class="p">)</span>

        <span class="c1">## create an obstacle to block the BS and the UE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_obstacle_list</span> <span class="o">=</span> <span class="n">Obstacle</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_obstacle_list</span><span class="o">.</span><span class="n">add_rect</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">w</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">each_block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_obstacle_list</span><span class="o">.</span><span class="n">get_list</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_drawable</span><span class="p">(</span><span class="n">Drawable</span><span class="p">()</span><span class="o">.</span><span class="n">polygon</span><span class="p">(</span><span class="n">each_block</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">set_drawing</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">BLUE_PEN</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">YELLOW_BRUSH</span><span class="p">))</span>

        <span class="c1">## create a BS on the map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="n">MyBS</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="s2">&quot;BS&quot;</span><span class="p">,</span> <span class="n">XY</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">y</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">set_obstacle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_obstacle_list</span><span class="p">)</span>

        <span class="c1">## create an RIS on the map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ris</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ris</span> <span class="o">=</span> <span class="n">MyRIS</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="s2">&quot;RIS&quot;</span><span class="p">,</span> <span class="n">XY</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="mi">119</span><span class="p">),</span><span class="n">y</span><span class="p">(</span><span class="mf">0.6</span><span class="p">)),</span> <span class="n">azimuth_angle</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
        <span class="n">ris</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">set_obstacle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_obstacle_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ris</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ris</span><span class="p">)</span>

        <span class="c1">## create a UE twin, one assited by RIS, one without</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">XY</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="mi">135</span><span class="p">),</span><span class="n">y</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="p">]</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">MyVehicle</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="s2">&quot;Vehicle1&quot;</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">StaticPath</span><span class="p">(</span><span class="n">start_loc</span><span class="o">=</span><span class="n">XY</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="mi">90</span><span class="p">),</span><span class="n">y</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">))</span>
        <span class="n">node</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">set_obstacle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_obstacle_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">XY</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="mi">135</span><span class="p">),</span><span class="n">y</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="p">]</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">MyVehicle</span><span class="p">(</span><span class="n">simworld</span><span class="p">,</span> <span class="s2">&quot;Vehicle2&quot;</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">set_mobility</span><span class="p">(</span><span class="n">StaticPath</span><span class="p">(</span><span class="n">start_loc</span><span class="o">=</span><span class="n">XY</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="mi">90</span><span class="p">),</span><span class="n">y</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">))</span>
        <span class="n">node</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">set_obstacle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_obstacle_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1">##-------------------------------------------------------------</span>
    <span class="c1">## This method will be called repeatedly until the simulation</span>
    <span class="c1">## is ended or stopped, perform any user simulation action here</span>
    <span class="k">def</span> <span class="nf">on_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">):</span>

        <span class="c1">## process mobility event only &amp; skip all other events</span>
        <span class="k">if</span> <span class="n">event_obj</span><span class="o">!=</span><span class="n">Event</span><span class="o">.</span><span class="n">SIM_MOBILITY</span><span class="p">:</span> <span class="k">return</span>

        <span class="c1">## initialize variables</span>
        <span class="n">snr_ris</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">snr_no_ris</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">## RIS service, here we hardcode the `RIS` to serve `Vehicle2`</span>
        <span class="n">ris_service</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ris_service</span><span class="p">[</span><span class="n">MyRIS</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s2">&quot;RIS&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">MyVehicle</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s2">&quot;Vehicle2&quot;</span><span class="p">)</span> <span class="c1"># comment out this line to disable RIS</span>

        <span class="c1">## BS transmission to vehicles</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="p">:</span>

            <span class="c1">## vehicle with RIS will receive a multpath signal, one from RIS, another from BS</span>
            <span class="c1">## here we need to prepare all reflected signals first</span>
            <span class="n">reflected_signal</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">reflected_signal</span><span class="p">[</span><span class="n">vehicle</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># all reflected signals to this `vehicle`</span>
            <span class="n">reflecting_ris</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">reflecting_ris</span><span class="p">[</span><span class="n">vehicle</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># all RISs reflecting the signals to this `vehicle`</span>
            <span class="k">for</span> <span class="n">this_ris</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ris</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">this_ris</span> <span class="ow">in</span> <span class="n">ris_service</span> <span class="ow">and</span> <span class="n">ris_service</span><span class="p">[</span><span class="n">this_ris</span><span class="p">]</span> <span class="ow">is</span> <span class="n">vehicle</span><span class="p">:</span>
                    <span class="c1">## first hop, BS-&gt;RIS</span>
                    <span class="n">packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_multipath_signal</span><span class="p">()</span>
                    <span class="n">bs2ris_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">unicast</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span><span class="n">this_ris</span><span class="p">)</span>
                    <span class="c1">## second hop, RIS-&gt;UE</span>
                    <span class="c1">## and keep `reflecting_ris` and `reflected_signal` in the list</span>
                    <span class="k">if</span> <span class="n">bs2ris_signal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">relay_packet</span> <span class="o">=</span> <span class="n">this_ris</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_multipath_signal</span><span class="p">(</span><span class="n">bs2ris_signal</span><span class="o">.</span><span class="n">quality</span><span class="p">)</span>
                        <span class="n">ris2node_signal</span> <span class="o">=</span> <span class="n">this_ris</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">unicast</span><span class="p">(</span><span class="n">relay_packet</span><span class="p">,</span><span class="n">vehicle</span><span class="p">)</span>
                        <span class="n">reflecting_ris</span><span class="p">[</span><span class="n">vehicle</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_ris</span><span class="p">)</span>
                        <span class="n">reflected_signal</span><span class="p">[</span><span class="n">vehicle</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ris2node_signal</span><span class="p">)</span>

            <span class="c1">## check whether BS to Vehicle is single or multipath</span>
            <span class="c1">## ie. check whether the vehicle has any reflected_signal</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reflected_signal</span><span class="p">[</span><span class="n">vehicle</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_signal</span><span class="p">()</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">associated_ris</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">create_final_multipath_signal</span><span class="p">(</span><span class="n">reflected_signal</span><span class="p">[</span><span class="n">vehicle</span><span class="p">])</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">associated_ris</span> <span class="o">=</span> <span class="n">reflecting_ris</span><span class="p">[</span><span class="n">vehicle</span><span class="p">]</span>

            <span class="c1">## retrieve the received signal after unicasting</span>
            <span class="n">recv_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">transceiver</span><span class="o">.</span><span class="n">unicast</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span><span class="n">vehicle</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">recv_signal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">associated_bs</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">associated_ris</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">connection_quality</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">associated_bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">connection_quality</span> <span class="o">=</span> <span class="n">recv_signal</span><span class="o">.</span><span class="n">quality</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">crossed_obstacle</span> <span class="o">=</span> <span class="n">recv_signal</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="s2">&quot;crossed_obstacle&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reflected_signal</span><span class="p">[</span><span class="n">vehicle</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">snr_no_ris</span> <span class="o">=</span> <span class="n">recv_signal</span><span class="o">.</span><span class="n">quality</span> <span class="o">-</span> <span class="n">MyTransceiver</span><span class="o">.</span><span class="n">noise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">snr_ris</span> <span class="o">=</span> <span class="n">recv_signal</span><span class="o">.</span><span class="n">quality</span> <span class="o">-</span> <span class="n">MyTransceiver</span><span class="o">.</span><span class="n">noise</span>

        <span class="c1">## show signal strength</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">distance_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">))</span>
        <span class="n">distance</span> <span class="o">/=</span> <span class="n">resolution</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distance = </span><span class="si">{</span><span class="n">distance</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;, Without RIS = </span><span class="si">{</span><span class="n">snr_no_ris</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> dB&quot;</span> <span class="k">if</span> <span class="n">snr_no_ris</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;, With RIS = </span><span class="si">{</span><span class="n">snr_ris</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> dB&quot;</span> <span class="k">if</span> <span class="n">snr_ris</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1">## collect results</span>
        <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">ris</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snr_ris</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">nris</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snr_no_ris</span><span class="p">)</span>

        <span class="c1">## show connections</span>
        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="p">:</span>
            <span class="n">vehicle</span><span class="o">.</span><span class="n">show_connection</span><span class="p">()</span>

<span class="c1">####################################################################</span>
<span class="c1">## main</span>
<span class="c1">####################################################################</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1">## command line parameters</span>
    <span class="n">parser</span><span class="p">:</span> <span class="n">ArgumentParser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--nodisplay&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run in no GUI mode&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--step&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Mobility step time (in sec)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--speed&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Animation playback speed (x times)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--duration&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Simulation duration (in sec), -1 for non-stop&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Namespace</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1">## welcome info</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Demonstration of RIS. Press [^C] to quit&quot;</span><span class="p">)</span>
    <span class="c1">#args.nodisplay = True  # &lt;-- hardcoding no GUI mode</span>
    <span class="n">args</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mf">0.1</span>         <span class="c1"># &lt;-- hardcoding the mobility step time</span>
    <span class="n">args</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mf">1.0</span>        <span class="c1"># &lt;-- hardcoding the animation speed (times)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mf">9.0</span>     <span class="c1"># &lt;-- hardcoding the sim duration (sec)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nodisplay</span><span class="p">:</span>   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- simulation will run without animation&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- animation will playback at x</span><span class="si">%1.2f</span><span class="s2"> speed&quot;</span><span class="o">%</span><span class="n">args</span><span class="o">.</span><span class="n">speed</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- vehicles move a step every </span><span class="si">%1.2f</span><span class="s2"> s in simulation&quot;</span><span class="o">%</span><span class="n">args</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">duration</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- simulation will stop at </span><span class="si">%1.2f</span><span class="s2"> s&quot;</span><span class="o">%</span><span class="n">args</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- simulation will run non-stop&quot;</span><span class="p">)</span>

    <span class="c1">## create, setup and run the simulation</span>
    <span class="c1">## note that to run a simulation, we need to create a &#39;scenario&#39;</span>
    <span class="n">run_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">run_flag</span><span class="p">:</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">World</span><span class="p">()</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">sim_stop</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> 
                <span class="n">sim_step</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> 
                <span class="n">sim_speed</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">speed</span><span class="p">,</span> 
                <span class="n">display_option</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">nodisplay</span><span class="p">,</span> 
                <span class="n">scenario</span> <span class="o">=</span> <span class="n">MyScenario</span><span class="p">(</span><span class="n">sim</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running PyMoSim version v</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">sim</span><span class="o">.</span><span class="n">version</span><span class="p">())</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">Result</span><span class="p">()</span>
        <span class="n">run_flag</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1">## plot results</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">ris</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;With RIS&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">nris</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Without RIS&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;SNR&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</details></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
</ul>
</div>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, cfoh.<br/>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.4.3.<br/>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>